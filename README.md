# sql_samples
A collection of my sample SQL files

*******************************************************
--------------------------------------------------------
--  DDL for View V_SUPERMARKET_DASHBOARD_V1
--------------------------------------------------------

  CREATE OR REPLACE FORCE EDITIONABLE VIEW "MINIMARKET"."V_SUPERMARKET_DASHBOARD_V1" ("SERIAL_NUMBER", "SECTION", "PART_BOARD", "PART_NUMBER", "PRODUCT", "BOARD_TYPES", "ACT_PICK_DATE", "ACT_PICK_TS", "EST_PICK_TS", "EST_PICK_DT", "ACT_STAGE_DATE", "ACT_STAGE_TS", "SHIFT", "KITS_TRIGGERED", "BUILDING", "PRIMARY_LOC", "BADGE_STAGE", "KITS_PICKED_CURR_PAST_DUE", "KITS_STAGED_ONTIME", "KITS_STAGED_DUE", "MISSING_PRTS", "MISSING_PRTS_STGD", "STAGE_ORDER", "PICKED_PARTS", "OVERALL_PICKED_PARTS", "PICKED_KITS", "PICKED_PARTS_RT", "PICKED_KITS_RT", "KITS_STGD", "KITS_STGD_RT", "PARTS_STGD", "PARTS_STGD_RT", "AUDITED_PARTS", "AUDITED_KITS", "EST_STAGE_TS", "ACT_SHIP_DATE", "ACT_SHIP_TS", "KITS_SHIPPED_ONTIME", "KITS_SHIPPED", "KITS_SHIPPED_RT", "PRTS_SHIPPED_COMPLETE", "PRTS_SHIPPED_COMPLETE_RT", "DELIVERED_ONTIME", "DELIVERED_KITS", "ARVL_DT", "ARVL_DATE", "ACT_RECEIVE_TS", "EST_DELIVER_TS", "ACT_DELIVER_TS", "ACT_DELIVER_DT", "TOTAL_RT_DELIVERED", "CREATION_TS", "CREATION_DT", "COMPLETION_TS", "COMPLETION_DT", "TOTAL_INTRANSIT_RT", "Source", "CURRENT_TIMESTAMP") AS 
  SELECT
UWPB.SERIAL_NUMBER,
UWPB.SECTION,
UWPB.PART_BOARD,
UWPP.PART_NUMBER,
UWPB.PRODUCT,
CASE WHEN UWPB.PART_BOARD LIKE '%Bulk%' THEN 'Bulk'
WHEN UWPB.PART_BOARD LIKE '%SHELF%' THEN 'Shelf'
WHEN UWPB.PART_BOARD LIKE '%TUBE%' THEN 'Tube'
WHEN UWPB.PART_BOARD LIKE '%FLATBED%' THEN 'Flatbed'
WHEN UWPB.PART_BOARD LIKE '%Film%' THEN 'Film'
ELSE 'Heavy' END AS BOARD_TYPES,
--CAST(UWPB.ACT_PICK_TS AS DATE) ACT_PICK_DATE,
TO_DATE(UWPB.ACT_PICK_TS, 'DD-MM-YY') ACT_PICK_DATE,
UWPB.ACT_PICK_TS,
UW.EST_PICK_TS,
--CAST(UW.EST_PICK_TS AS DATE) EST_PICK_DT,
TO_DATE(UW.EST_PICK_TS, 'DD-MM-YY') EST_PICK_DT,
--CAST(UWPB.ACT_STAGE_TS AS DATE) ACT_STAGE_DATE,
TO_DATE(UWPB.ACT_STAGE_TS, 'DD-MM-YY') ACT_STAGE_DATE,
UWPB.ACT_STAGE_TS,
CASE WHEN EXTRACT(HOUR FROM CAST(UWPB.ACT_STAGE_TS AS TIMESTAMP)) >= 7 AND EXTRACT(HOUR FROM CAST(UWPB.ACT_STAGE_TS AS TIMESTAMP)) <15 THEN '1st Shift'
WHEN EXTRACT(HOUR FROM CAST(UWPB.ACT_STAGE_TS AS TIMESTAMP)) >= 15 AND EXTRACT(HOUR FROM CAST(UWPB.ACT_STAGE_TS AS TIMESTAMP)) <23 THEN '2nd Shift'
ELSE '3rd Shift' END AS SHIFT,
CONCAT( CONCAT(UWPB.SERIAL_NUMBER, UWPB.SECTION), UWPB.PART_BOARD) AS KITS_TRIGGERED,
SUBSTR(UWPP.PRIMARY_LOC,0,1) "BUILDING",
UWPP.PRIMARY_LOC,
UWPB.BADGE_STAGE,
CASE WHEN UWPB.ACT_STAGE_TS IS NULL AND UW.EST_PICK_TS IS NOT NULL AND (SYSDATE  - UW.EST_PICK_TS)*24 > 24 THEN CONCAT( CONCAT(UWPB.SERIAL_NUMBER, UWPB.SECTION), UWPB.PART_BOARD) END AS KITS_PICKED_CURR_PAST_DUE,

CASE WHEN UWPB.ACT_STAGE_TS IS NOT NULL AND TO_CHAR(UW.EST_PICK_TS,'D') = 7 AND (UWPB.ACT_STAGE_TS - UW.EST_PICK_TS )*24  <=48 THEN CONCAT( CONCAT(UWPB.SERIAL_NUMBER, UWPB.SECTION), UWPB.PART_BOARD)
WHEN UWPB.ACT_STAGE_TS IS NOT NULL AND TO_CHAR(UW.EST_PICK_TS,'D') <> 7 AND (UWPB.ACT_STAGE_TS - UW.EST_PICK_TS )*24  <=24 THEN CONCAT( CONCAT(UWPB.SERIAL_NUMBER, UWPB.SECTION), UWPB.PART_BOARD) END AS KITS_STAGED_ONTIME,

CASE WHEN UWPB.ACT_STAGE_TS IS NOT NULL AND TO_CHAR(UW.EST_PICK_TS,'D') = 7 AND (UWPB.ACT_STAGE_TS - UW.EST_PICK_TS )*24  > 48 THEN CONCAT( CONCAT(UWPB.SERIAL_NUMBER, UWPB.SECTION), UWPB.PART_BOARD)
WHEN UWPB.ACT_STAGE_TS IS NOT NULL AND TO_CHAR(UW.EST_PICK_TS,'D') <> 7 AND (UWPB.ACT_STAGE_TS - UW.EST_PICK_TS )*24  > 24 THEN CONCAT( CONCAT(UWPB.SERIAL_NUMBER, UWPB.SECTION), UWPB.PART_BOARD) END AS KITS_STAGED_DUE,


CASE WHEN UWMP.SERIAL_NUMBER IS NOT NULL  THEN CONCAT( CONCAT(UWPB.SERIAL_NUMBER, UWPB.SECTION), UWMP.PART_BOARD) END AS MISSING_PRTS,
CASE WHEN UWMP.SERIAL_NUMBER IS NOT NULL AND UWPB.STAGE_ORDER = 3 THEN CONCAT( CONCAT(UWPB.SERIAL_NUMBER, UWPB.SECTION), UWMP.PART_BOARD) END AS MISSING_PRTS_STGD,
UWPB.STAGE_ORDER,
CASE WHEN UWPB.STAGE_ORDER >= 3 THEN CONCAT(CONCAT( CONCAT(UWPB.SERIAL_NUMBER, UWPB.SECTION), UWPB.PART_BOARD),UWPP.PART_NUMBER) END  AS PICKED_PARTS,
UWPP.QTY_PICKED OVERALL_PICKED_PARTS,
CASE WHEN UWPB.ACT_STAGE_TS IS NOT NULL THEN CONCAT( CONCAT(UWPB.SERIAL_NUMBER, UWPB.SECTION), UWPB.PART_BOARD) END AS PICKED_KITS,

CASE WHEN UWMP.SERIAL_NUMBER IS NOT NULL AND  UWPB.ACT_STAGE_TS IS NOT NULL THEN CONCAT(CONCAT( CONCAT(UWPB.SERIAL_NUMBER, UWPB.SECTION), UWPB.PART_BOARD),UWMP.PART_NUMBER) END AS PICKED_PARTS_RT,
CASE WHEN UWMP.SERIAL_NUMBER IS NOT NULL AND  UWPB.ACT_STAGE_TS IS NOT NULL THEN CONCAT( CONCAT(UWPB.SERIAL_NUMBER, UWPB.SECTION), UWMP.PART_BOARD) END AS PICKED_KITS_RT,

CASE WHEN UWPB.ACT_STAGE_TS IS NOT NULL THEN CONCAT( CONCAT(UWPB.SERIAL_NUMBER, UWPB.SECTION), UWPB.PART_BOARD) END AS KITS_STGD,
CASE WHEN UWPB.ACT_STAGE_TS IS NOT NULL AND UWMP.SERIAL_NUMBER IS NOT NULL THEN CONCAT( CONCAT(UWPB.SERIAL_NUMBER, UWPB.SECTION), UWMP.PART_BOARD) END AS KITS_STGD_RT,
CASE WHEN UWPB.ACT_STAGE_TS IS NOT NULL  THEN CONCAT(CONCAT( CONCAT(UWPB.SERIAL_NUMBER, UWPB.SECTION), UWPB.PART_BOARD),UWPP.PART_NUMBER) END AS PARTS_STGD,
CASE WHEN UWPB.ACT_STAGE_TS IS NOT NULL AND UWMP.SERIAL_NUMBER IS NOT NULL THEN CONCAT(CONCAT( CONCAT(UWPB.SERIAL_NUMBER, UWPB.SECTION), UWPB.PART_BOARD),UWMP.PART_NUMBER) END AS PARTS_STGD_RT,
CASE WHEN UWPB.ACT_SHIP_TS IS NOT NULL THEN CONCAT(CONCAT( CONCAT(UWPB.SERIAL_NUMBER, UWPB.SECTION), UWPB.PART_BOARD),UWPP.PART_NUMBER) END AS AUDITED_PARTS,
CASE WHEN UWPB.ACT_SHIP_TS IS NOT NULL THEN CONCAT( CONCAT(UWPB.SERIAL_NUMBER, UWPB.SECTION), UWPB.PART_BOARD) END AS AUDITED_KITS,
UW.EST_STAGE_TS,
--CAST(UWPB.ACT_SHIP_TS AS DATE) ACT_SHIP_DATE,
TO_DATE(UWPB.ACT_SHIP_TS, 'DD-MM-YY') ACT_SHIP_DATE,
UWPB.ACT_SHIP_TS,
CASE WHEN UWPB.ACT_SHIP_TS IS NOT NULL AND (UWPB.ACT_SHIP_TS - UW.EST_PICK_TS)*24  <=24 THEN CONCAT( CONCAT(UWPB.SERIAL_NUMBER, UWPB.SECTION), UWPB.PART_BOARD) END AS KITS_SHIPPED_ONTIME,
CASE WHEN UWPB.ACT_SHIP_TS IS NOT NULL THEN CONCAT( CONCAT(UWPB.SERIAL_NUMBER, UWPB.SECTION), UWPB.PART_BOARD) END AS KITS_SHIPPED,
CASE WHEN UWMP.SERIAL_NUMBER IS NOT NULL AND UWPB.ACT_SHIP_TS IS NOT NULL THEN CONCAT( CONCAT(UWPB.SERIAL_NUMBER, UWPB.SECTION), UWMP.PART_BOARD) END AS KITS_SHIPPED_RT,
CASE WHEN UWPB.ACT_SHIP_TS IS NOT NULL THEN CONCAT(CONCAT( CONCAT(UWPB.SERIAL_NUMBER, UWPB.SECTION), UWPB.PART_BOARD),UWPP.PART_NUMBER) END AS PRTS_SHIPPED_COMPLETE,
CASE WHEN UWMP.SERIAL_NUMBER IS NOT NULL AND UWPB.ACT_SHIP_TS IS NOT NULL THEN CONCAT(CONCAT( CONCAT(UWPB.SERIAL_NUMBER, UWPB.SECTION), UWPB.PART_BOARD),UWMP.PART_NUMBER) END AS PRTS_SHIPPED_COMPLETE_RT,
CASE WHEN CPT.ARVL_DT IS NOT NULL AND (CPT.ARVL_DT - UW.EST_DELIVER_TS)*24  <=4   THEN CONCAT( CONCAT(UWPB.SERIAL_NUMBER, UWPB.SECTION), UWPB.PART_BOARD) END AS DELIVERED_ONTIME,
CASE WHEN CPT.ARVL_DT IS NOT NULL  THEN CONCAT( CONCAT(UWPB.SERIAL_NUMBER, UWPB.SECTION), UWPB.PART_BOARD) END AS DELIVERED_KITS,
--CASE WHEN (CPT.ARVL_DT - UW.ACT_RECEIVE_TS)*24  <=4 THEN 1 ELSE 0 END AS DELIVERED_ONTIME,
CPT.ARVL_DT,
TO_DATE(CPT.ARVL_DT, 'DD-MM-YY') ARVL_DATE,
UWPB.ACT_RECEIVE_TS,
UW.EST_DELIVER_TS,
UWPB.ACT_DELIVER_TS,
TO_DATE(UWPB.ACT_DELIVER_TS, 'DD-MM-YY') ACT_DELIVER_DT,
CASE WHEN UWMP.SERIAL_NUMBER IS NOT NULL AND CPT.ARVL_DT IS NOT NULL AND UWMP.COMPLETION_TS > CPT.ARVL_DT
THEN CONCAT(CONCAT( CONCAT(UWPB.SERIAL_NUMBER, UWPB.SECTION), UWPB.PART_BOARD),UWMP.PART_NUMBER) END AS TOTAL_RT_DELIVERED,
UWMP.CREATION_TS,
--CAST(UWMP.CREATION_TS AS DATE) CREATION_DT,
TO_DATE(UWMP.CREATION_TS, 'DD-MM-YY') CREATION_DT,
UWMP.COMPLETION_TS,
--CAST(UWMP.COMPLETION_TS AS DATE) COMPLETION_DT,
TO_DATE(UWMP.COMPLETION_TS, 'DD-MM-YY') COMPLETION_DT,
CASE WHEN UWMP.SERIAL_NUMBER IS NOT NULL AND UWMP.CURR_INV_AREA LIKE '%INTRANSIT%' AND UWMP.COMPLETION_TS IS NULL THEN CONCAT(CONCAT( CONCAT(UWPB.SERIAL_NUMBER, UWPB.SECTION), UWPB.PART_BOARD),UWMP.PART_NUMBER) END AS TOTAL_INTRANSIT_RT,
'W SPRMRKT' AS Source,
CURRENT_TIMESTAMP


FROM  SPRMRKTMGR.UNIT_WORK_PART_BOARD UWPB
LEFT JOIN SPRMRKTMGR.UNIT_WORK UW
    ON TRIM(UW.SERIAL_NUMBER) = TRIM(UWPB.SERIAL_NUMBER)
    AND TRIM(UW.SECTION) = TRIM(UWPB.SECTION)
LEFT JOIN SPRMRKTMGR.UNIT_WORK_MISSING_PART UWMP
    ON TRIM(UWMP.SERIAL_NUMBER) = TRIM(UWPB.SERIAL_NUMBER)
    AND TRIM(UWMP.SECTION) = TRIM(UWPB.SECTION)
LEFT JOIN SPRMRKTMGR.UNIT_WORK_PICKED_PART UWPP
    ON TRIM(UWPP.SERIAL_NUMBER) = TRIM(UW.SERIAL_NUMBER)
    AND TRIM(UWPP.PART_BOARD) = TRIM(UWPB.PART_BOARD)
    AND TRIM(UWPP.SECTION) = TRIM(UW.SECTION)
LEFT JOIN
(
    SELECT
    MATL_LD_BARCODE,
    MAX(CPT.ARVL_DT) AS ARVL_DT
    FROM CPTMGR.V_BCT_ALL_MATERIAL@CPT.MCE.NA.CAT.COM CPT 
    WHERE LENGTH(LOC) = 5  AND LOC NOT LIKE '%D RS%' AND LOC NOT LIKE '%RS4%' AND LOC NOT LIKE 'K%'
    GROUP BY MATL_LD_BARCODE
) CPT
    ON UWPB.BCT_BAR_CODE = CPT.MATL_LD_BARCODE
WHERE UWPB.BADGE_PICK <> 'auto'
AND TO_DATE(UW.EST_PICK_TS, 'DD-MM-YY') >= '01-JAN-21' 


UNION ALL

SELECT
UWPB.SERIAL_NUMBER,
UWPB.SECTION,
UWPB.PART_BOARD,
UWPP.PART_NUMBER,
UWPB.PRODUCT,
CASE WHEN UWPB.PART_BOARD LIKE '%Bulk%' THEN 'Bulk'
WHEN UWPB.PART_BOARD LIKE '%SHELF%' THEN 'Shelf'
WHEN UWPB.PART_BOARD LIKE '%TUBE%' THEN 'Tube'
WHEN UWPB.PART_BOARD LIKE '%FLATBED%' THEN 'Flatbed'
WHEN UWPB.PART_BOARD LIKE '%Film%' THEN 'Film'
ELSE 'Heavy' END AS BOARD_TYPES,
--CAST(UWPB.ACT_PICK_TS AS DATE) ACT_PICK_DATE,
TO_DATE(UWPB.ACT_PICK_TS, 'DD-MM-YY') ACT_PICK_DATE,
UWPB.ACT_PICK_TS,
UW.EST_PICK_TS,
--CAST(UW.EST_PICK_TS AS DATE) EST_PICK_DT,
TO_DATE(UW.EST_PICK_TS, 'DD-MM-YY') EST_PICK_DT,
--CAST(UWPB.ACT_STAGE_TS AS DATE) ACT_STAGE_DATE,
TO_DATE(UWPB.ACT_STAGE_TS, 'DD-MM-YY') ACT_STAGE_DATE,
UWPB.ACT_STAGE_TS,
CASE WHEN EXTRACT(HOUR FROM CAST(UWPB.ACT_STAGE_TS AS TIMESTAMP)) >= 7 AND EXTRACT(HOUR FROM CAST(UWPB.ACT_STAGE_TS AS TIMESTAMP)) <15 THEN '1st Shift'
WHEN EXTRACT(HOUR FROM CAST(UWPB.ACT_STAGE_TS AS TIMESTAMP)) >= 15 AND EXTRACT(HOUR FROM CAST(UWPB.ACT_STAGE_TS AS TIMESTAMP)) <23 THEN '2nd Shift'
ELSE '3rd Shift' END AS SHIFT,
CONCAT( CONCAT(UWPB.SERIAL_NUMBER, UWPB.SECTION), UWPB.PART_BOARD) AS KITS_TRIGGERED,
SUBSTR(UWPP.PRIMARY_LOC,0,1) "BUILDING",
UWPP.PRIMARY_LOC,
UWPB.BADGE_STAGE,
CASE WHEN UWPB.ACT_STAGE_TS IS NULL AND UW.EST_PICK_TS IS NOT NULL AND (SYSDATE  - UW.EST_PICK_TS)*24 > 24 THEN CONCAT( CONCAT(UWPB.SERIAL_NUMBER, UWPB.SECTION), UWPB.PART_BOARD) END AS KITS_PICKED_CURR_PAST_DUE,

CASE WHEN UWPB.ACT_STAGE_TS IS NOT NULL AND TO_CHAR(UW.EST_PICK_TS,'D') = 7 AND (UWPB.ACT_STAGE_TS - UW.EST_PICK_TS )*24  <=48 THEN CONCAT( CONCAT(UWPB.SERIAL_NUMBER, UWPB.SECTION), UWPB.PART_BOARD)
WHEN UWPB.ACT_STAGE_TS IS NOT NULL AND TO_CHAR(UW.EST_PICK_TS,'D') <> 7 AND (UWPB.ACT_STAGE_TS - UW.EST_PICK_TS )*24  <=24 THEN CONCAT( CONCAT(UWPB.SERIAL_NUMBER, UWPB.SECTION), UWPB.PART_BOARD) END AS KITS_STAGED_ONTIME,

CASE WHEN UWPB.ACT_STAGE_TS IS NOT NULL AND TO_CHAR(UW.EST_PICK_TS,'D') = 7 AND (UWPB.ACT_STAGE_TS - UW.EST_PICK_TS )*24  > 48 THEN CONCAT( CONCAT(UWPB.SERIAL_NUMBER, UWPB.SECTION), UWPB.PART_BOARD)
WHEN UWPB.ACT_STAGE_TS IS NOT NULL AND TO_CHAR(UW.EST_PICK_TS,'D') <> 7 AND (UWPB.ACT_STAGE_TS - UW.EST_PICK_TS )*24  > 24 THEN CONCAT( CONCAT(UWPB.SERIAL_NUMBER, UWPB.SECTION), UWPB.PART_BOARD) END AS KITS_STAGED_DUE,


CASE WHEN UWMP.SERIAL_NUMBER IS NOT NULL  THEN CONCAT( CONCAT(UWPB.SERIAL_NUMBER, UWPB.SECTION), UWMP.PART_BOARD) END AS MISSING_PRTS,
CASE WHEN UWMP.SERIAL_NUMBER IS NOT NULL AND UWPB.STAGE_ORDER = 3 THEN CONCAT( CONCAT(UWPB.SERIAL_NUMBER, UWPB.SECTION), UWMP.PART_BOARD) END AS MISSING_PRTS_STGD,
UWPB.STAGE_ORDER,
CASE WHEN UWPB.STAGE_ORDER >= 3 THEN CONCAT(CONCAT( CONCAT(UWPB.SERIAL_NUMBER, UWPB.SECTION), UWPB.PART_BOARD),UWPP.PART_NUMBER) END  AS PICKED_PARTS,
UWPP.QTY_PICKED OVERALL_PICKED_PARTS,
CASE WHEN UWPB.ACT_STAGE_TS IS NOT NULL THEN CONCAT( CONCAT(UWPB.SERIAL_NUMBER, UWPB.SECTION), UWPB.PART_BOARD) END AS PICKED_KITS,

CASE WHEN UWMP.SERIAL_NUMBER IS NOT NULL AND  UWPB.ACT_STAGE_TS IS NOT NULL THEN CONCAT(CONCAT( CONCAT(UWPB.SERIAL_NUMBER, UWPB.SECTION), UWPB.PART_BOARD),UWMP.PART_NUMBER) END AS PICKED_PARTS_RT,
CASE WHEN UWMP.SERIAL_NUMBER IS NOT NULL AND  UWPB.ACT_STAGE_TS IS NOT NULL THEN CONCAT( CONCAT(UWPB.SERIAL_NUMBER, UWPB.SECTION), UWMP.PART_BOARD) END AS PICKED_KITS_RT,

CASE WHEN UWPB.ACT_STAGE_TS IS NOT NULL THEN CONCAT( CONCAT(UWPB.SERIAL_NUMBER, UWPB.SECTION), UWPB.PART_BOARD) END AS KITS_STGD,
CASE WHEN UWPB.ACT_STAGE_TS IS NOT NULL AND UWMP.SERIAL_NUMBER IS NOT NULL THEN CONCAT( CONCAT(UWPB.SERIAL_NUMBER, UWPB.SECTION), UWMP.PART_BOARD) END AS KITS_STGD_RT,
CASE WHEN UWPB.ACT_STAGE_TS IS NOT NULL  THEN CONCAT(CONCAT( CONCAT(UWPB.SERIAL_NUMBER, UWPB.SECTION), UWPB.PART_BOARD),UWPP.PART_NUMBER) END AS PARTS_STGD,
CASE WHEN UWPB.ACT_STAGE_TS IS NOT NULL AND UWMP.SERIAL_NUMBER IS NOT NULL THEN CONCAT(CONCAT( CONCAT(UWPB.SERIAL_NUMBER, UWPB.SECTION), UWPB.PART_BOARD),UWMP.PART_NUMBER) END AS PARTS_STGD_RT,
CASE WHEN UWPB.ACT_SHIP_TS IS NOT NULL THEN CONCAT(CONCAT( CONCAT(UWPB.SERIAL_NUMBER, UWPB.SECTION), UWPB.PART_BOARD),UWPP.PART_NUMBER) END AS AUDITED_PARTS,
CASE WHEN UWPB.ACT_SHIP_TS IS NOT NULL THEN CONCAT( CONCAT(UWPB.SERIAL_NUMBER, UWPB.SECTION), UWPB.PART_BOARD) END AS AUDITED_KITS,
UW.EST_STAGE_TS,
--CAST(UWPB.ACT_SHIP_TS AS DATE) ACT_SHIP_DATE,
TO_DATE(UWPB.ACT_SHIP_TS, 'DD-MM-YY') ACT_SHIP_DATE,
UWPB.ACT_SHIP_TS,
CASE WHEN UWPB.ACT_SHIP_TS IS NOT NULL AND (UWPB.ACT_SHIP_TS - UW.EST_PICK_TS)*24  <=24 THEN CONCAT( CONCAT(UWPB.SERIAL_NUMBER, UWPB.SECTION), UWPB.PART_BOARD) END AS KITS_SHIPPED_ONTIME,
CASE WHEN UWPB.ACT_SHIP_TS IS NOT NULL THEN CONCAT( CONCAT(UWPB.SERIAL_NUMBER, UWPB.SECTION), UWPB.PART_BOARD) END AS KITS_SHIPPED,
CASE WHEN UWMP.SERIAL_NUMBER IS NOT NULL AND UWPB.ACT_SHIP_TS IS NOT NULL THEN CONCAT( CONCAT(UWPB.SERIAL_NUMBER, UWPB.SECTION), UWMP.PART_BOARD) END AS KITS_SHIPPED_RT,
CASE WHEN UWPB.ACT_SHIP_TS IS NOT NULL THEN CONCAT(CONCAT( CONCAT(UWPB.SERIAL_NUMBER, UWPB.SECTION), UWPB.PART_BOARD),UWPP.PART_NUMBER) END AS PRTS_SHIPPED_COMPLETE,
CASE WHEN UWMP.SERIAL_NUMBER IS NOT NULL AND UWPB.ACT_SHIP_TS IS NOT NULL THEN CONCAT(CONCAT( CONCAT(UWPB.SERIAL_NUMBER, UWPB.SECTION), UWPB.PART_BOARD),UWMP.PART_NUMBER) END AS PRTS_SHIPPED_COMPLETE_RT,
CASE WHEN CPT.ARVL_DT IS NOT NULL AND (CPT.ARVL_DT - UW.EST_DELIVER_TS)*24  <=4 THEN CONCAT( CONCAT(UWPB.SERIAL_NUMBER, UWPB.SECTION), UWPB.PART_BOARD) END AS DELIVERED_ONTIME,
CASE WHEN CPT.ARVL_DT IS NOT NULL  THEN CONCAT( CONCAT(UWPB.SERIAL_NUMBER, UWPB.SECTION), UWPB.PART_BOARD) END AS DELIVERED_KITS,
--CASE WHEN (CPT.ARVL_DT - UW.ACT_RECEIVE_TS)*24  <=4 THEN 1 ELSE 0 END AS DELIVERED_ONTIME,
CPT.ARVL_DT,
TO_DATE(CPT.ARVL_DT, 'DD-MM-YY') ARVL_DATE,
UWPB.ACT_RECEIVE_TS,
UW.EST_DELIVER_TS,
UWPB.ACT_DELIVER_TS,
TO_DATE(UWPB.ACT_DELIVER_TS, 'DD-MM-YY') ACT_DELIVER_DT,
CASE WHEN UWMP.SERIAL_NUMBER IS NOT NULL AND CPT.ARVL_DT IS NOT NULL AND  UWMP.COMPLETION_TS > CPT.ARVL_DT
THEN CONCAT(CONCAT( CONCAT(UWPB.SERIAL_NUMBER, UWPB.SECTION), UWPB.PART_BOARD),UWMP.PART_NUMBER) END AS TOTAL_RT_DELIVERED,
UWMP.CREATION_TS,
--CAST(UWMP.CREATION_TS AS DATE) CREATION_DT,
TO_DATE(UWMP.CREATION_TS, 'DD-MM-YY') CREATION_DT,
UWMP.COMPLETION_TS,
--CAST(UWMP.COMPLETION_TS AS DATE) COMPLETION_DT,
TO_DATE(UWMP.COMPLETION_TS, 'DD-MM-YY') COMPLETION_DT,
CASE WHEN UWMP.SERIAL_NUMBER IS NOT NULL AND UWMP.CURR_INV_AREA LIKE '%INTRANSIT%' AND UWMP.COMPLETION_TS IS NULL THEN CONCAT(CONCAT( CONCAT(UWPB.SERIAL_NUMBER, UWPB.SECTION), UWPB.PART_BOARD),UWMP.PART_NUMBER) END AS TOTAL_INTRANSIT_RT,
'CP SPRMRKT' AS Source,
CURRENT_TIMESTAMP



FROM  RSPRMRKTMGR.UNIT_WORK_PART_BOARD@RSPRMRKTMGR.CIS.CAT.COM UWPB
LEFT JOIN RSPRMRKTMGR.UNIT_WORK@RSPRMRKTMGR.CIS.CAT.COM UW
    ON TRIM(UW.SERIAL_NUMBER) = TRIM(UWPB.SERIAL_NUMBER)
    AND TRIM(UW.SECTION) = TRIM(UWPB.SECTION)
LEFT JOIN RSPRMRKTMGR.UNIT_WORK_MISSING_PART@RSPRMRKTMGR.CIS.CAT.COM UWMP
    ON TRIM(UWMP.SERIAL_NUMBER) = TRIM(UWPB.SERIAL_NUMBER)
    AND TRIM(UWMP.SECTION) = TRIM(UWPB.SECTION)
LEFT JOIN RSPRMRKTMGR.UNIT_WORK_PICKED_PART@RSPRMRKTMGR.CIS.CAT.COM UWPP
    ON TRIM(UWPP.SERIAL_NUMBER) = TRIM(UW.SERIAL_NUMBER)
    AND TRIM(UWPP.PART_BOARD) = TRIM(UWPB.PART_BOARD)
    AND TRIM(UWPP.SECTION) = TRIM(UW.SECTION)
LEFT JOIN
(
    SELECT
    MATL_LD_BARCODE,
    MAX(CPT.ARVL_DT) AS ARVL_DT
    FROM CPTMGR.V_BCT_ALL_MATERIAL@CPT.MCE.NA.CAT.COM CPT 
     WHERE LENGTH(LOC) = 5  AND LOC NOT LIKE '%D RS%' AND LOC NOT LIKE '%RS4%' AND LOC NOT LIKE 'K%'
    GROUP BY MATL_LD_BARCODE
) CPT
    ON UWPB.BCT_BAR_CODE = CPT.MATL_LD_BARCODE
WHERE UWPB.BADGE_PICK <> 'auto'
AND TO_DATE(UW.EST_PICK_TS, 'DD-MM-YY') >= '01-JAN-21'
;



*******************************************************
--------------------------------------------------------
--  DDL for View V_POU_SHORT_SHEET_2
--------------------------------------------------------

  CREATE OR REPLACE FORCE EDITIONABLE VIEW "MINIMARKET"."V_POU_SHORT_SHEET_2" ("CURRENT_DATE", "LINE", "Serial_number", "PART_BOARD", "PART_NUMBER", "ZONE_ID", "CNSM_SPUR", "PART_DESCRIPTION", "MISSING_QTY", "Red W Kit Yellow CP", "In House", "DEMAND_DT", "eta_date", "Creation_Date", "LPA", "pou_comments", "root_cause", "threep_cont", "CLOSE_DATE", "Closed_Yesterday", "SRC", "CPT_SN", "MRP_DEMAND_DT", "CONSUMED", "COVERAGE_MTS", "AVL_STOCK_MTS", "RTS_DT", "EST_SOL_DT", "LN_SEQ_NO", "FIRST_MISS", "CURRENT_TIMESTAMP") AS 
  SELECT Final.CURRENT_DATE,
  --Final.LINE,
  CASE WHEN DD.MODEL = 'D Sub Assembly' THEN 'D Sub Assembly' ELSE Final.LINE END as LINE,
  Final.Serial_number,
  Final.PART_BOARD,
  Final.PART_NUMBER,
  Final.ZONE_ID,
  Final.CNSM_SPUR,
  Final.PART_DESCRIPTION,
  Final.QTY,
  Final."Red W Kit Yellow CP",
  CASE WHEN Final.CURR_INV_ON_HAND IS NULL THEN 'UNKNOWN'
  WHEN Final.CURR_INV_ON_HAND = 0 THEN 'NO'
  WHEN Final.CURR_INV_ON_HAND > 0 THEN 'YES' END AS "In House", 
  DM.req_dt as DEMAND_DT,
  --NVL(Final.DEMAND_DT, DD.DEMAND_DT) AS DEMAND_DT,
  NVL(Final.eta_date, DD.eta_date) AS eta_date,
  NVL(Final.Creation_Date, DD.Creation_Date) AS Creation_Date,
  NVL(Final.LPA, DD.comments) AS LPA,
  NVL(Final.pou_comments, DD.pou_comments) AS pou_comments,
  NVL(Final.root_cause, DD.root_cause) AS root_cause,
  NVL(Final.threep_cont, DD.threep_cont) AS threep_cont,
  NVL(Final.CLOSE_DATE, DD.CLOSE_DATE) AS CLOSE_DATE,
  CASE WHEN TO_DATE(Final.CLOSE_DATE) = TO_DATE(CURRENT_DATE - 1) THEN 'Yes' ELSE 'No' END AS Closed_Yesterday,
    Final.SRC,
  Final.CPT_SN,
  MRP.demand_dt AS MRP_DEMAND_DT,
  CASE WHEN MRP.demand_dt IS NULL THEN 'Y' ELSE 'N' END AS CONSUMED,
  CASE WHEN Final.QTY <= STK.AVL_STOCK THEN 'Y' ELSE 'N' END AS COVERAGE_MTS,
  NVL(STK.AVL_STOCK, 0) AS AVL_STOCK_MTS,
  MES.RTS_DT,
  MES.EST_SOL_DT,
  MES.LN_SEQ_NO,
  CASE WHEN SUM( Final.QTY) OVER(PARTITION BY  Final.PART_NUMBER ORDER BY Final.Serial_number ) > NVL(STK.AVL_STOCK, 0) 
  THEN 'FIRST_MISS' ELSE 'FINE' END 
  AS FIRST_MISS ,
  CURRENT_TIMESTAMP
  FROM
  (
  
    (
  SELECT
     CURRENT_DATE
    ,CAST(A.LINE AS VARCHAR(20)) AS LINE
    ,A.Serial_number
    ,A.PART_BOARD
    ,A.PART_NUMBER
    ,A.BIN_LOC AS ZONE_ID
    ,B.SPUR AS CNSM_SPUR
    ,A.PART_DESCRIPTION
    ,A.MISSING_QTY AS QTY
    ,A.curr_loc AS "Red W Kit Yellow CP"
    ,A.CURR_INV_ON_HAND 
    ,B.DEMAND_DT
    ,B.eta_date
    ,B.Creation_Date
    ,B.comments AS LPA 
    ,B.pou_comments
    ,B.root_cause
    ,B.threep_cont 
    ,'SPRMRKT' AS SRC
    ,B.Serial_number AS CPT_SN
    ,B.CLOSE_DATE
FROM
(
SELECT 
     Serial_number 
    ,PRODUCT AS "LINE"
    ,PART_BOARD 
    ,TRIM(PART_NUMBER) AS PART_NUMBER
    ,PART_DESCRIPTION
    ,MISSING_QTY
      , CASE WHEN CURR_INV_BLDG = 'W KIT' THEN 'W KIT' 
        WHEN  CURR_INV_BLDG = 'FR KIT' THEN 'FR KIT' 
        WHEN  CURR_INV_AREA LIKE  '%W KIT%' THEN 'W KIT' 
        WHEN  CURR_INV_AREA LIKE  '%FR KIT%' THEN 'FR KIT'
        WHEN  CURR_INV_AREA LIKE  '%W REPL%' THEN 'W KIT' 
        WHEN  CURR_INV_AREA LIKE  '%W WS%' THEN 'W KIT'
        WHEN  CURR_INV_AREA LIKE  '%REPL%' THEN 'W KIT'
        ELSE CONCAT(CONCAT(CURR_INV_BLDG , ' '), CURR_INV_AREA) END as curr_loc
      ,BIN_LOC
      ,CURR_INV_ON_HAND
FROM sprmrktmgr.unit_work_missing_part
     WHERE MISSING_QTY > 0
     AND SUBSTR(TRIM(PRIMARY_LOC), 1,1) = 'D'
UNION  
    
SELECT
     Serial_number 
    ,PRODUCT AS "LINE"
    ,PART_BOARD 
    ,TRIM(PART_NUMBER) AS PART_NUMBER
    ,PART_DESCRIPTION
    ,MISSING_QTY
     , CASE WHEN CURR_INV_BLDG = 'W KIT' THEN 'W KIT' 
        WHEN  CURR_INV_BLDG = 'FR KIT' THEN 'FR KIT' 
        WHEN  CURR_INV_AREA LIKE  '%W KIT%' THEN 'W KIT' 
        WHEN  CURR_INV_AREA LIKE  '%FR KIT%' THEN 'FR KIT' 
        WHEN  CURR_INV_AREA LIKE  '%W REPL%' THEN 'W KIT' 
        WHEN  CURR_INV_AREA LIKE  '%W WS%' THEN 'W KIT'
        WHEN  CURR_INV_AREA LIKE  '%REPL%' THEN 'W KIT'
        ELSE CONCAT(CONCAT(CURR_INV_BLDG , ' '), CURR_INV_AREA) END as curr_loc2 
    , BIN_LOC
    , CURR_INV_ON_HAND
FROM rsprmrktmgr.unit_work_missing_part@RSPRMRKTMGR.CIS.CAT.COM
WHERE MISSING_QTY > 0
AND SUBSTR(TRIM(PRIMARY_LOC), 1,1) = 'D'



) A
LEFT JOIN
(
   SELECT *
     FROM
      (
      SELECT
        part_number,
         ROW_NUMBER() OVER(PARTITION BY part_number ORDER BY Creation_Date DESC) RNK,
        serial_number,
        Creation_Date,
        root_cause,
        eta_date,
        comments,
        pou_comments,
        threep_cont,
        demand_dt,
        SPUR,
        CLOSE_DATE
    FROM cptmgr.hot_sheet@CPT.MCE.NA.CAT.COM
    ) WHERE RNK = 1
   
) B
ON TRIM(A.part_number) = TRIM(B.part_number)
--AND TRIM(A.serial_number) = TRIM(B.serial_number)
--WHERE TRIM(A.part_number) LIKE  '%3475007%'

UNION 

SELECT

  CURRENT_DATE
    
    ,CAST(A.LINE AS VARCHAR(20)) AS LINE
    ,A.Serial_number
    ,A.PART_BOARD
    ,A.PART_NUMBER
    ,A.ZONE_ID
    ,A.CNSM_SPUR
    ,A.PART_DESCRIPTION
    ,A.MISSING_QTY AS QTY
    ,A.curr_loc AS "Red W Kit Yellow CP"
   , NULL AS CURR_INV_ON_HAND 
     ,B.DEMAND_DT
    ,B.eta_date
    ,B.Creation_Date
    ,B.comments AS LPA 
    ,B.pou_comments
    ,B.root_cause
    ,B.threep_cont 
    ,'MES' AS SRC
    ,B.Serial_number AS CPT_SN
    ,B.CLOSE_DATE
    
FROM
(


SELECT  
    --concat(SUBSTR(v_mes_supp_ord.prod_sn,1,3) ,  CAST( cast (subSTR(v_mes_supp_ord.prod_sn,4,5)  AS int) AS VARCHAR(5))) as Serial_number,
    v_mes_supp_ord.prod_sn AS Serial_number,
    v_mes_supp_ord.prod_sn AS Serial_number2,
    --mes_cnsm_itm.CNSM_ITM_LN_NO AS LINE,
     --mes_prod13.qwb2_sn_pfx.fac_prod_fam_cd  AS LINE,
     
     CASE WHEN mes_prod13.qwb2_sn_pfx.FAC_PROD_FAM_CD = 'LT793'
     THEN CONCAT('LT',mes_prod13.qwb2_sn_pfx.MODEL_GROUP) ELSE FAC_PROD_FAM_CD END AS LINE,
    mes_opn_exec.area_id AS CNSM_SPUR,
    CONCAT('FLOOR ', mes_opn_exec.area_id) AS PART_BOARD,
    mes_cnsm_itm.cnsm_itm_cat_id_no    AS part_number,
    mes_cnsm_itm.cnsm_itm_cid_abr_nm   AS PART_DESCRIPTION,
    substr(mes_cnsm_itm.bld_bay, 1, 2) AS curr_loc,
    ZONE_ID,
    SUM(mes_cnsm_itm.cnsm_itm_qty_opn) AS missing_qty
    
FROM
     mes_cnsm_itm@A3P4.CIS.CAT.COM
    INNER JOIN  mes_opn_exec@A3P4.CIS.CAT.COM
        ON mes_opn_exec.mes_opn_tag = mes_cnsm_itm.mes_opn_tag
    INNER JOIN  v_mes_supp_ord@A3P4.CIS.CAT.COM
        ON  v_mes_supp_ord.supp_ord_egg_tag = mes_opn_exec.supp_ord_tag
    INNER JOIN mes_prod13.qwb2_sn_pfx
        ON mes_prod13.qwb2_sn_pfx.SN_PFX = v_mes_supp_ord.SN_PFX
 WHERE mes_opn_exec.curr_stat_ind = 'C'
    AND mes_opn_exec.OPN_CMPLT_TS IS NULL
    AND substr(mes_cnsm_itm.bld_bay, 1, 2) is not null
    AND mes_cnsm_itm.cnsm_itm_cat_id_no <> '0000000'
    AND V_mes_supp_ord.shp_dt is null
   AND ( ZONE_ID LIKE 'FLR%' OR ( (ZONE_ID = 'V1300CAB6' OR ZONE_ID = 'V1300CAB8'OR ZONE_ID = 'V1300CAB5') 
      AND  (TRIM(mes_cnsm_itm.cnsm_itm_cat_id_no)  LIKE '%5838358%' 
      OR TRIM(mes_cnsm_itm.cnsm_itm_cat_id_no)  LIKE '%4675992%'
      OR TRIM(mes_cnsm_itm.cnsm_itm_cat_id_no)  LIKE '%2939321%'
      OR TRIM(mes_cnsm_itm.cnsm_itm_cat_id_no)  LIKE '%3992148%'
      OR TRIM(mes_cnsm_itm.cnsm_itm_cat_id_no)  LIKE '%3359819%'
      OR TRIM(mes_cnsm_itm.cnsm_itm_cat_id_no)  LIKE '%3709088%'
      OR TRIM(mes_cnsm_itm.cnsm_itm_cat_id_no)  LIKE '%5778126%'
      OR TRIM(mes_cnsm_itm.cnsm_itm_cat_id_no)  LIKE '%4937713%'
      ) ))
    AND (SUBSTR(TRIM(BLD_BAY),1,1) ='D'
                OR
                
                ( mes_opn_exec.area_id IN ('Y68', 'Y63',  'S93' , 'W99', 'W11', 'Q58', 'Q59', 'Q69', 'Y16')
                AND SUBSTR(TRIM(BLD_BAY),1,1) ='B' )
                
                )
    --AND TRIM(mes_cnsm_itm.cnsm_itm_cat_id_no)  LIKE '%5838358%'
GROUP BY 
    mes_cnsm_itm.cnsm_itm_cat_id_no,
    mes_cnsm_itm.cnsm_itm_cid_abr_nm,
    substr(mes_cnsm_itm.bld_bay, 1, 2),
    mes_opn_exec.area_id,
    v_mes_supp_ord.prod_sn,
    --mes_cnsm_itm.CNSM_ITM_LN_NO,
    CASE WHEN mes_prod13.qwb2_sn_pfx.FAC_PROD_FAM_CD = 'LT793'
     THEN CONCAT('LT',mes_prod13.qwb2_sn_pfx.MODEL_GROUP) ELSE FAC_PROD_FAM_CD END ,
    ZONE_ID
) A

INNER JOIN

(
     
     SELECT *
     FROM
      (
      SELECT
        part_number,
         ROW_NUMBER() OVER(PARTITION BY part_number ORDER BY Creation_Date DESC) RNK,
        serial_number,
        Creation_Date,
        root_cause,
        eta_date,
        comments,
        pou_comments,
        threep_cont,
        demand_dt,
        CLOSE_DATE
    FROM cptmgr.hot_sheet@CPT.MCE.NA.CAT.COM
    ) WHERE RNK = 1
   
) B
ON ( TRIM(A.part_number) = TRIM(B.part_number)
AND TRIM(A.serial_number) = TRIM(B.serial_number)

)

OR



( TRIM(A.part_number) = TRIM(B.part_number)
--AND TRIM(A.serial_number2) = TRIM(B.serial_number)

AND SUBSTR(TRIM(A.serial_number2),1,2) = SUBSTR(TRIM(B.serial_number),1,2)
--AND SUBSTR(TRIM(A.serial_number2),LENGTH(TRIM(A.serial_number2))-1,2) = SUBSTR(TRIM(B.serial_number),LENGTH(TRIM(A.serial_number2))-1,2)

)
--WHERE  TRIM(A.part_number) LIKE '%3475007%'

) Final
LEFT JOIN 
(
    SELECT DISTINCT
        serial_number,
        part_number,
        req_dt
    FROM  dm_complete_demand@Z1PDD.CIS.CAT.COM
) DM
    
    ON TRIM(DM.part_number) = TRIM(Final.part_number)
    AND TRIM(DM.serial_number) = TRIM(Final.serial_number)
   -- AND (           SUBSTR(TRIM(DM.serial_number),1,2) = SUBSTR(TRIM(Final.serial_number),1,2)     )
    
   
   LEFT JOIN  cptmgr.hot_sheet@CPT.MCE.NA.CAT.COM DD
    ON TRIM(Final.part_number) = TRIM(DD.part_number)
 
    LEFT JOIN 
 
 (
        SELECT 
            prod_sn,
            part_number,
            TO_CHAR(TO_DATE(TO_CHAR(MAX(demand_dt)), 'yyyymmdd') , 'MM/DD/YYYY') as demand_dt
        FROM supplymgr.detailed_demand@A3PI7.MCE.NA.CAT.COM
            WHERE PROD_SN IS NOT NULL
            GROUP BY prod_sn,
                    part_number
) MRP
    ON TRIM(Final.part_number) = TRIM(MRP.part_number)
    AND TRIM(FinaL.Serial_number) = TRIM(MRP.prod_sn)

LEFT JOIN
(
    select 
    CTCO_IDENT_NO AS PART_NBR, 
    COORD,
    NVL(SUM(tot_ld_qty), 0) AS AVL_STOCK  
    FROM(
    SELECT DISTINCT * FROM 
SPRMRKTMGR.V_MTS_INV
--WHERE CTCO_IDENT_NO LIKE '%5220764%' 
    )

    GROUP BY CTCO_IDENT_NO, COORD

) STK ON

TRIM(STK.PART_NBR) = TRIM(Final.Part_number)
AND TRIM(STK.COORD) = TRIM(Final.ZONE_ID)


    -- 6/10/21 Script updated to limit records only with corresponding POU Need Date
LEFT JOIN
(
SELECT  DISTINCT
    v_mes_supp_ord.prod_sn AS Serial_number,
    mes_cnsm_itm.cnsm_itm_cat_id_no    AS part_number,
    v_mes_supp_ord.RTS_DT AS RTS_DT,
    v_mes_supp_ord.EST_SOL_DT AS EST_SOL_DT,
    v_mes_supp_ord.LN_SEQ_NO AS LN_SEQ_NO

FROM
    mes_cnsm_itm@A3P4.CIS.CAT.COM
    INNER JOIN  mes_opn_exec@A3P4.CIS.CAT.COM
        ON mes_opn_exec.mes_opn_tag = mes_cnsm_itm.mes_opn_tag
    INNER JOIN  v_mes_supp_ord@A3P4.CIS.CAT.COM
        ON  v_mes_supp_ord.supp_ord_egg_tag = mes_opn_exec.supp_ord_tag

--        WHERE mes_opn_exec.curr_stat_ind = 'C'
--    AND mes_opn_exec.OPN_CMPLT_TS IS NULL
) MES ON

TRIM(MES.part_number) = TRIM(Final.Part_number)
AND TRIM(MES.Serial_number) = TRIM(Final.Serial_number)

   )

--    WHERE DM.req_dt IS NOT NULL
--    OR MRP.demand_dt IS NOT NULL
;



*******************************************************
--------------------------------------------------------
--  DDL for View V_KIT_UTILIZATION
--------------------------------------------------------

  CREATE OR REPLACE FORCE EDITIONABLE VIEW "MINIMARKET"."V_KIT_UTILIZATION" ("SECTION", "SECTION_", "SPUR", "PART_NUMBER", "PART_BOARD", "PRODUCT", "CONFIGURED_TIME", "PARTBOARD_LOC", "CONFIGURED_BY", "RNK", "MODEL", "TOP_LVL", "SECTION_P", "ITEM", "OPERATION", "LINE", "SER_PFX", "CONSUMPTION_LOC", "PART_LOC", "STD_ATT", "SRC", "CURRENT_TIMESTAMP") AS 
  SELECT

 SECTION,
SECTION_,
SPUR,
PART_NUMBER,
PART_BOARD,
PRODUCT,
CONFIGURED_TIME,
PARTBOARD_LOC,
CONFIGURED_BY,
RNK,
MODEL,
TOP_LVL,
SECTION_P,
ITEM,
OPERATION,
LINE,
SER_PFX,
CONSUMPTION_LOC,
PART_LOC,
STD_ATT,
SRC,
CURRENT_TIMESTAMP

FROM
(
SELECT SUBSTR(K.SECTION,1,5) AS SECTION
,K.SECTION AS SECTION_
,SUBSTR(K.SECTION,-3,3) AS SPUR
,K.PART_NUMBER
,K.PART_BOARD
,K.PRODUCT
,K.CONFIG_TS AS CONFIGURED_TIME
,K.BLDG_LOC AS PARTBOARD_LOC
,K.CONFIG_BY AS CONFIGURED_BY
,RANK() OVER (PARTITION BY K.PART_NUMBER, K.SECTION, P.LINE ORDER BY K.CONFIG_TS DESC) as rnk
--,ROW_NUMBER() OVER (PARTITION BY K.PART_NUMBER, K.SECTION, P.LINE ORDER BY K.CONFIG_TS DESC) as rnk      /*To adress entires with same K.CONFIG_TS*/
,M.SALES_NBR AS MODEL
,P.TOP_LVL
,P.SECTION AS SECTION_P
,P.ITEM
,P.OPERATION
,P.LINE
,SPFX.SER_PFX
,P.BLDG_LOC AS CONSUMPTION_LOC
,P.PART_LOC
,P.STD_ATT
,'W SPRMRKT' AS SRC


FROM V_WSPRMKT_PARTS@A3P5.CIS.CAT.COM_Z1XB001$ P
LEFT JOIN  "SPRMRKTMGR"."PROD_SECT_BOARD_PART_LOC" K
    ON TRIM(SUBSTR(K.SECTION,1,5)) = TRIM(P.SECTION)
        AND TRIM(K.PART_NUMBER) = TRIM(P.ITEM)

INNER JOIN z1xb001$.model_info@A3P5.CIS.CAT.COM_Z1XB001$ M  
    ON TRIM(P.TOP_LVL) = TRIM(M.TOP_LVL)
INNER JOIN toplvl_serialprefix SPFX
   ON TRIM(P.TOP_LVL) = TRIM(SPFX.top_level) 
WHERE K.PART_NUMBER IS NOT NULL 
AND P.PART_LOC IS NOT NULL 
AND P.PART_LOC like '%MLC%'
AND SUBSTR(K.SECTION,-3,3) = SUBSTR(P.PART_LOC,-3,3)



UNION


  SELECT SUBSTR(K.SECTION,1,5) AS SECTION
,K.SECTION AS SECTION_
,SUBSTR(K.SECTION,-3,3) AS SPUR
,K.PART_NUMBER
,K.PART_BOARD
,K.PRODUCT
,K.CONFIG_TS AS CONFIGURED_TIME
,K.BLDG_LOC AS PARTBOARD_LOC
,K.CONFIG_BY AS CONFIGURED_BY
,RANK() OVER (PARTITION BY K.PART_NUMBER, K.SECTION, P.LINE ORDER BY K.CONFIG_TS DESC) as rnk
--,ROW_NUMBER() OVER (PARTITION BY K.PART_NUMBER, K.SECTION, P.LINE ORDER BY K.CONFIG_TS DESC) as rnk      /*To adress entires with same K.CONFIG_TS*/
,M.SALES_NBR AS MODEL
,P.TOP_LVL
,P.SECTION AS SECTION_P
,P.ITEM
,P.OPERATION
,P.LINE
,SPFX.SER_PFX
,P.BLDG_LOC AS CONSUMPTION_LOC
,P.PART_LOC
,P.STD_ATT
,'CP SPRMRKT' AS SRC

FROM V_WSPRMKT_PARTS@A3P5.CIS.CAT.COM_Z1XB001$ P
LEFT JOIN  RSPRMRKTMGR.PROD_SECT_BOARD_PART_LOC@RSPRMRKTMGR.CIS.CAT.COM K
    ON TRIM(SUBSTR(K.SECTION,1,5)) = TRIM(P.SECTION)
        AND TRIM(K.PART_NUMBER) = TRIM(P.ITEM)
INNER JOIN z1xb001$.model_info@A3P5.CIS.CAT.COM_Z1XB001$ M  
    ON TRIM(P.TOP_LVL) = TRIM(M.TOP_LVL)
INNER JOIN toplvl_serialprefix SPFX
    ON TRIM(P.TOP_LVL) = TRIM(SPFX.top_level) 
WHERE K.PART_NUMBER IS NOT NULL --AND K.PART_NUMBER LIKE '%5416638%'
AND P.PART_LOC IS NOT NULL
AND P.PART_LOC like '%MLC%'
AND SUBSTR(K.SECTION,-3,3) = SUBSTR(P.PART_LOC,-3,3)

)
WHERE RNK >= 1
;



*******************************************************
--------------------------------------------------------
--  DDL for View V_ALERT_BOARD_V3
--------------------------------------------------------

  CREATE OR REPLACE FORCE EDITIONABLE VIEW "MINIMARKET"."V_ALERT_BOARD_V3" ("Group", "OnTime_OverDue", "MATL_MV_ORD_ID", "MATL_LD_DET_ID", "MATL_LD_BARCODE", "MATL_LD_LCN", "PART_NO", "PART_NM", "QTY", "STATUS", "LOC", "TRNSP_VEH_BARCODE", "TO_BLDG", "TO_AREA", "TO_CORD", "FROM_BLDG", "FROM_AREA", "FROM_CORD", "ARVL_DT", "UPDT_CWS_ID", "UPDT_NM", "CURRENT_REC", "CURRENT_TIMESTAMP", "RNK", "MULTIPLE_CURRENT", "CURR_CNT", "DATA_FILTER") AS 
  SELECT 'Campus to Trailer' AS "Group" , 
CASE WHEN ( EXTRACT( DAY FROM CURRENT_TIMESTAMP  - ARVL_DT)*24 + EXTRACT( HOUR FROM CURRENT_TIMESTAMP  - ARVL_DT)) > 8
 THEN 'Over Due' ELSE 'On Time' END AS OnTime_OverDue,
 MATL_MV_ORD_ID, 
MATL_LD_DET_ID, 
MATL_LD_BARCODE, 
MATL_LD_LCN, 
PART_NO, 
PART_NM, 
QTY, 
STATUS, 
LOC, 
TRNSP_VEH_BARCODE, 
TO_BLDG, 
TO_AREA, 
TO_CORD, 
FROM_BLDG, 
FROM_AREA, 
FROM_CORD, 
ARVL_DT, 
UPDT_CWS_ID, 
UPDT_NM, 
CURRENT_REC,
CURRENT_TIMESTAMP,
ROW_NUMBER() OVER( PARTITION BY MATL_LD_BARCODE ORDER BY MATL_MV_ORD_ID DESC) RNK,
CASE WHEN  COUNT(CASE WHEN CURRENT_REC = 'C' THEN 1 END) OVER(PARTITION BY MATL_LD_BARCODE) > 1 
THEN 'YES' ELSE 'NO' END AS MULTIPLE_CURRENT,
COUNT(CASE WHEN CURRENT_REC = 'C' THEN 1 END) OVER(PARTITION BY MATL_LD_BARCODE) AS CURR_CNT,
CASE WHEN
        LOC NOT LIKE '%FR KIT%' OR
        LOC NOT LIKE '%FR STN%' OR
        LOC NOT LIKE '%REPACK%' OR
        LOC NOT LIKE '%BOUND%' OR
        LOC NOT LIKE '%AD1%' OR
        LOC NOT LIKE '%AD2%' OR
        LOC NOT LIKE '%FD%' OR
        LOC NOT LIKE '%KIT%' OR
        LOC NOT LIKE '%STN%' OR
        LOC NOT LIKE '%STAGE%' OR
        LOC NOT LIKE '%DOC%' OR
        LOC NOT LIKE '%FR%' OR
        LOC NOT LIKE '%C %' OR
        LOC NOT LIKE 'C%' OR
        LOC NOT LIKE '%C0%' OR
        LOC NOT LIKE '%C1%' OR
        LOC NOT LIKE '%C2%' OR
        LOC NOT LIKE '%C3%' OR
        LOC NOT LIKE 'E%' OR  
        LOC NOT LIKE 'B1%'OR 
        LOC NOT LIKE 'B2%'OR
        LOC NOT LIKE 'B3%'OR
        LOC NOT LIKE 'B4%'OR
        LOC NOT LIKE 'F1%'



THEN 'FILTER OUT'
ELSE 'GOOD'
END AS DATA_FILTER

FROM   cptmgr.v_bct_all_material@CPT.MCE.NA.CAT.COM

WHERE  
(to_bldg LIKE '%FR%'
AND TO_DATE(ARVL_DT, 'DD-MM-YY') > TO_DATE(CURRENT_DATE)-3
AND FROM_AREA NOT LIKE '%WS%'
AND FROM_BLDG LIKE '%W%'
AND FROM_AREA NOT LIKE '%MRC%'
AND FROM_AREA NOT LIKE '%LOIN%'
AND FROM_AREA NOT LIKE '%KIT%'
AND FROM_AREA NOT LIKE '%SALV%'
AND FROM_AREA NOT LIKE '%RPK%' 
)

OR (
		TRNSP_VEH_BARCODE IS NULL
)
AND CURRENT_REC LIKE 'C'

UNION ALL 

SELECT 'Trailer On Hill/In Door at CP' AS "Group",
 CASE WHEN ( EXTRACT( DAY FROM CURRENT_TIMESTAMP  - ARVL_DT)*24 + EXTRACT( HOUR FROM CURRENT_TIMESTAMP  - ARVL_DT)) > 12
 THEN 'Over Due' ELSE 'On Time' END AS OnTime_OverDue,
MATL_MV_ORD_ID, 
MATL_LD_DET_ID, 
MATL_LD_BARCODE, 
MATL_LD_LCN, 
PART_NO, 
PART_NM, 
QTY, 
STATUS, 
LOC, 
TRNSP_VEH_BARCODE, 
TO_BLDG, 
TO_AREA, 
TO_CORD, 
FROM_BLDG, 
FROM_AREA, 
FROM_CORD, 
ARVL_DT, 
UPDT_CWS_ID, 
UPDT_NM, 
CURRENT_REC,
CURRENT_TIMESTAMP,
ROW_NUMBER() OVER( PARTITION BY MATL_LD_BARCODE ORDER BY MATL_MV_ORD_ID DESC) RNK,
CASE WHEN  COUNT(CASE WHEN CURRENT_REC = 'C' THEN 1 END) OVER(PARTITION BY MATL_LD_BARCODE) > 1 
THEN 'YES' ELSE 'NO' END AS MULTIPLE_CURRENT
,COUNT(CASE WHEN CURRENT_REC = 'C' THEN 1 END) OVER(PARTITION BY MATL_LD_BARCODE) AS CURR_CNT,
--,COUNT(1) OVER(PARTITION BY MATL_LD_BARCODE) AS CNT,

CASE WHEN
        LOC LIKE '%BOUND%'
        OR LOC LIKE '%AD1%'
        OR LOC LIKE '%AD2%'
        OR LOC LIKE '%FD%'


        THEN 'FILTER OUT'

        ELSE 'GOOD'

        END AS DATA_FILTER

FROM
    cptmgr.v_bct_all_material@CPT.MCE.NA.CAT.COM

WHERE  (to_bldg LIKE '%FR%'
AND TO_DATE(ARVL_DT, 'DD-MM-YY') > TO_DATE(CURRENT_DATE)-3 AND TRNSP_VEH_BARCODE IS NOT NULL
AND FROM_AREA NOT LIKE '%WS%'
AND FROM_BLDG LIKE '%W%'
AND FROM_AREA NOT LIKE '%MRC%'
AND FROM_AREA NOT LIKE '%LOIN%'
AND FROM_AREA NOT LIKE '%KIT%'
AND FROM_AREA NOT LIKE '%SALV%'
AND FROM_AREA NOT LIKE '%RPK%'
AND TO_AREA NOT LIKE '%STRP%'
AND TRNSP_VEH_BARCODE IS NOT NULL
)
AND CURRENT_REC LIKE 'C'

UNION ALL

SELECT 'FR Dock to OCL/repack area' AS "Group",
 CASE WHEN ( EXTRACT( DAY FROM CURRENT_TIMESTAMP  - ARVL_DT)*24 + EXTRACT( HOUR FROM CURRENT_TIMESTAMP  - ARVL_DT)) > 12
 THEN 'Over Due' ELSE 'On Time' END AS OnTime_OverDue,
MATL_MV_ORD_ID, 
MATL_LD_DET_ID, 
MATL_LD_BARCODE, 
MATL_LD_LCN, 
PART_NO, 
PART_NM, 
QTY, 
STATUS, 
LOC, 
TRNSP_VEH_BARCODE, 
TO_BLDG, 
TO_AREA, 
TO_CORD, 
FROM_BLDG, 
FROM_AREA, 
FROM_CORD, 
ARVL_DT, 
UPDT_CWS_ID, 
UPDT_NM, 
CURRENT_REC,
CURRENT_TIMESTAMP,
ROW_NUMBER() OVER( PARTITION BY MATL_LD_BARCODE ORDER BY MATL_MV_ORD_ID DESC) RNK,
CASE WHEN  COUNT(CASE WHEN CURRENT_REC = 'C' THEN 1 END) OVER(PARTITION BY MATL_LD_BARCODE) > 1 
THEN 'YES' ELSE 'NO' END AS MULTIPLE_CURRENT
,COUNT(CASE WHEN CURRENT_REC = 'C' THEN 1 END) OVER(PARTITION BY MATL_LD_BARCODE) AS CURR_CNT,
--,COUNT(1) OVER(PARTITION BY MATL_LD_BARCODE) AS CNT

CASE WHEN

        LOC LIKE '%BOUND%'
        OR LOC LIKE '%AD1%'
        OR LOC LIKE '%AD2%'
        OR LOC NOT LIKE '%FR KIT%'
        OR LOC NOT LIKE '%FR STN%'
        OR LOC NOT LIKE '%REPACK%'



        THEN 'FILTER OUT'

        ELSE 'GOOD'

        END AS DATA_FILTER



FROM   cptmgr.v_bct_all_material@CPT.MCE.NA.CAT.COM 
WHERE  
        ( to_bldg LIKE '%FR%'
        AND TO_DATE(ARVL_DT, 'DD-MM-YY') > TO_DATE(CURRENT_DATE)-3
        AND FROM_AREA NOT LIKE '%WS%'
        AND FROM_BLDG LIKE '%W%'
        AND FROM_AREA NOT LIKE '%MRC%'
        AND FROM_AREA NOT LIKE '%LOIN%'
        AND FROM_AREA NOT LIKE '%KIT%'
        AND FROM_AREA NOT LIKE '%SALV%'
        AND FROM_AREA NOT LIKE '%RPK%' 
        )


AND
        (  
        TRNSP_VEH_BARCODE IS NULL
) 
AND TO_AREA NOT LIKE '%STRP%'
AND CURRENT_REC LIKE 'C'
;



*******************************************************
--------------------------------------------------------
--  DDL for View CPTCOMPLIANCE
--------------------------------------------------------

  CREATE OR REPLACE FORCE EDITIONABLE VIEW "MINIMARKET"."CPTCOMPLIANCE" ("CREATION_DATE", "SECTION", "PART_NUMBER", "SERIAL_NUMBER", "ETA_DATE", "RCVD_DT", "ETA_QUANTITY", "RCVD_QTY", "ISSUE_DESCRIPTION", "CLOSE_DATE", "RSF", "POU_CLOSE_DATE", "COMMENTS", "POU_COMMENTS", "HISTORY_COMMENTS", "UPDATEDDT", "DEMAND_DT", "REC_LOC") AS 
  WITH CTE_SCIM_PART AS (
    SELECT PART_NUMBER, REC_LOC, RSF FROM scimmgr.PART_INFORMATION@A3P7.CIS.CAT.COM_MINIMARKET
)
SELECT CP.creation_date,
       CP.section,
       CP.PART_NUMBER,
       CP.SERIAL_NUMBER,
       CP.ETA_DATE,
       CP.RCVD_DT,
       CP.ETA_QUANTITY,
       CP.RCVD_QTY,
       CP.ISSUE_DESCRIPTION,
       CP.close_date,
       CP.RSF,
       CP.pou_close_date,
       CP.comments,
       CP.pou_comments,
       CP.history_comments,
       CP.UPDATEDDT,
       CP.DEMAND_DT,
       SP.REC_LOC FROM
    (SELECT
    to_char(creation_date,'mm/dd/yy hh24:mi') creation_date,hs.section,
    hs.PART_NUMBER,SERIAL_NUMBER,to_char(hs.ETA_DATE,'mm/dd/yy') ETA_DATE,
    to_char(hs.RCVD_DT,'mm/dd/yy') RCVD_DT,
    hs.ETA_QUANTITY, hs.RCVD_QTY, nvl(ISSUE_DESCRIPTION,' ') ISSUE_DESCRIPTION,
    to_char(CLOSE_DATE,'mm/dd/yy hh24:mi') close_date,hs.RSF, to_char(hs.POU_CLOSE_DT,'mm/dd/yy hh24:mi') pou_close_date,
    hs.model,hs.line_down_indicator,hs.LN_DN_DT,hs.LN_DN_HRS,hs.LN_DN_MINS,hs.TW_SLOT,hs.TRAFFIC_NO, nvl(hs.COMMENTS,' ') comments,
    nvl(hs.POU_COMMENTS,' ') pou_comments, nvl(hsc.CMNT,' ') history_comments, nvl(hsc.POU_CMNT,' ') history_pou_comments,
    nvl(hsc.UPDT_BY_CWSID,' ') comment_auth, nvl(to_char(hsc.UPDT_DT,'mm/dd/yy hh24:mi'),' ') UPDATEDDT,
    nvl(em.emstatus,' ') emstatus, to_char(hs.DEMAND_DT,'mm/dd/yy') DEMAND_DT,
    nvl(hs.spur, ' ') spur, hs.ira_spd_qty, nvl(hs.cnt_req, ' ') cnt_req, nvl(hs.supp_nm,' ') supp_nm,
    nvl(hs.root_cause, ' ') root_cause, nvl(hs.model_type, ' ') model_type, nvl(hs.ppmc, ' ') ppmc,
    nvl(hs.LN_DOWN_CAUSE_NM, ' ') LN_DOWN_CAUSE_NM
FROM
    cptmgr.hot_sheet@CPT.MCE.NA.CAT.COM hs,
        cptmgr.product@CPT.MCE.NA.CAT.COM p,
        (select
            a.part_no,a.updt_dt,a.updt_by_cwsid,a.cmnt,a.pou_cmnt, a.prod_nm,a.sect
        from
            cptmgr.hot_sheet_hist@CPT.MCE.NA.CAT.COM a,
            (select max(updt_dt) updt_dt,part_no,prod_nm from hot_sheet_hist group by part_no,prod_nm) b
        where
            a.part_no=b.part_no
            and a.prod_nm=b.prod_nm
            and a.updt_dt=b.updt_dt) hsc,
        (SELECT
            Distinct e.PART_NUMBER, 'BDD' emstatus
        FROM
            cptmgr.POU_LOC_QTY@A3P7.CIS.CAT.COM_MINIMARKET POU, cptmgr.EXPEDITE_MSGS@A3P7.CIS.CAT.COM_MINIMARKET e
        WHERE POU.PART_NO = e.PART_NUMBER AND POU.POU_LOC LIKE  TO_BLDG ||' ' || TO_AREA ||'%') em
WHERE approved_creator_flag='Y' AND hs.part_number<>' '
      AND hsc.part_no(+)=hs.part_number
      AND hsc.PROD_NM(+)=hs.model
      AND hsc.sect(+)=hs.section
      AND hs.model  = p.prod_typ
      AND em.PART_NUMBER(+) = hs.part_number
      AND hs.SERIAL_NUMBER not like '%OOB%') CP
LEFT JOIN SCIMMGR.CTE_SCIM_PART SP
    ON CP.PART_NUMBER = SP.PART_NUMBER
    AND CP.RSF = SP.RSF
    --WHERE CP.PART_NUMBER LIKE '%1141157%'
;



*******************************************************
--------------------------------------------------------
--  DDL for View V_KIT_UTILIZATION
--------------------------------------------------------

  CREATE OR REPLACE FORCE EDITIONABLE VIEW "MINIMARKET"."V_KIT_UTILIZATION" ("SECTION", "SECTION_", "SPUR", "PART_NUMBER", "PART_BOARD", "PRODUCT", "CONFIGURED_TIME", "PARTBOARD_LOC", "CONFIGURED_BY", "RNK", "MODEL", "TOP_LVL", "SECTION_P", "ITEM", "OPERATION", "LINE", "SER_PFX", "CONSUMPTION_LOC", "PART_LOC", "STD_ATT", "SRC", "CURRENT_TIMESTAMP") AS 
  SELECT

 SECTION,
SECTION_,
SPUR,
PART_NUMBER,
PART_BOARD,
PRODUCT,
CONFIGURED_TIME,
PARTBOARD_LOC,
CONFIGURED_BY,
RNK,
MODEL,
TOP_LVL,
SECTION_P,
ITEM,
OPERATION,
LINE,
SER_PFX,
CONSUMPTION_LOC,
PART_LOC,
STD_ATT,
SRC,
CURRENT_TIMESTAMP

FROM
(
SELECT SUBSTR(K.SECTION,1,5) AS SECTION
,K.SECTION AS SECTION_
,SUBSTR(K.SECTION,-3,3) AS SPUR
,K.PART_NUMBER
,K.PART_BOARD
,K.PRODUCT
,K.CONFIG_TS AS CONFIGURED_TIME
,K.BLDG_LOC AS PARTBOARD_LOC
,K.CONFIG_BY AS CONFIGURED_BY
,RANK() OVER (PARTITION BY K.PART_NUMBER, K.SECTION, P.LINE ORDER BY K.CONFIG_TS DESC) as rnk
--,ROW_NUMBER() OVER (PARTITION BY K.PART_NUMBER, K.SECTION, P.LINE ORDER BY K.CONFIG_TS DESC) as rnk      /*To adress entires with same K.CONFIG_TS*/
,M.SALES_NBR AS MODEL
,P.TOP_LVL
,P.SECTION AS SECTION_P
,P.ITEM
,P.OPERATION
,P.LINE
,SPFX.SER_PFX
,P.BLDG_LOC AS CONSUMPTION_LOC
,P.PART_LOC
,P.STD_ATT
,'W SPRMRKT' AS SRC


FROM V_WSPRMKT_PARTS@A3P5.CIS.CAT.COM_Z1XB001$ P
LEFT JOIN  "SPRMRKTMGR"."PROD_SECT_BOARD_PART_LOC" K
    ON TRIM(SUBSTR(K.SECTION,1,5)) = TRIM(P.SECTION)
        AND TRIM(K.PART_NUMBER) = TRIM(P.ITEM)

INNER JOIN z1xb001$.model_info@A3P5.CIS.CAT.COM_Z1XB001$ M  
    ON TRIM(P.TOP_LVL) = TRIM(M.TOP_LVL)
INNER JOIN toplvl_serialprefix SPFX
   ON TRIM(P.TOP_LVL) = TRIM(SPFX.top_level) 
WHERE K.PART_NUMBER IS NOT NULL 
AND P.PART_LOC IS NOT NULL 
AND P.PART_LOC like '%MLC%'
AND SUBSTR(K.SECTION,-3,3) = SUBSTR(P.PART_LOC,-3,3)



UNION


  SELECT SUBSTR(K.SECTION,1,5) AS SECTION
,K.SECTION AS SECTION_
,SUBSTR(K.SECTION,-3,3) AS SPUR
,K.PART_NUMBER
,K.PART_BOARD
,K.PRODUCT
,K.CONFIG_TS AS CONFIGURED_TIME
,K.BLDG_LOC AS PARTBOARD_LOC
,K.CONFIG_BY AS CONFIGURED_BY
,RANK() OVER (PARTITION BY K.PART_NUMBER, K.SECTION, P.LINE ORDER BY K.CONFIG_TS DESC) as rnk
--,ROW_NUMBER() OVER (PARTITION BY K.PART_NUMBER, K.SECTION, P.LINE ORDER BY K.CONFIG_TS DESC) as rnk      /*To adress entires with same K.CONFIG_TS*/
,M.SALES_NBR AS MODEL
,P.TOP_LVL
,P.SECTION AS SECTION_P
,P.ITEM
,P.OPERATION
,P.LINE
,SPFX.SER_PFX
,P.BLDG_LOC AS CONSUMPTION_LOC
,P.PART_LOC
,P.STD_ATT
,'CP SPRMRKT' AS SRC

FROM V_WSPRMKT_PARTS@A3P5.CIS.CAT.COM_Z1XB001$ P
LEFT JOIN  RSPRMRKTMGR.PROD_SECT_BOARD_PART_LOC@RSPRMRKTMGR.CIS.CAT.COM K
    ON TRIM(SUBSTR(K.SECTION,1,5)) = TRIM(P.SECTION)
        AND TRIM(K.PART_NUMBER) = TRIM(P.ITEM)
INNER JOIN z1xb001$.model_info@A3P5.CIS.CAT.COM_Z1XB001$ M  
    ON TRIM(P.TOP_LVL) = TRIM(M.TOP_LVL)
INNER JOIN toplvl_serialprefix SPFX
    ON TRIM(P.TOP_LVL) = TRIM(SPFX.top_level) 
WHERE K.PART_NUMBER IS NOT NULL --AND K.PART_NUMBER LIKE '%5416638%'
AND P.PART_LOC IS NOT NULL
AND P.PART_LOC like '%MLC%'
AND SUBSTR(K.SECTION,-3,3) = SUBSTR(P.PART_LOC,-3,3)

)
WHERE RNK >= 1
;



*******************************************************
--------------------------------------------------------
--  DDL for View V_SUPERMARKET_SHP_DLVRY_V1
--------------------------------------------------------

  CREATE OR REPLACE FORCE EDITIONABLE VIEW "MINIMARKET"."V_SUPERMARKET_SHP_DLVRY_V1" ("SERIAL_NUMBER", "SECTION", "PART_BOARD", "MATL_LD_BARCODE", "LOC", "BOARD_TYPES", "ACT_PICK_DATE", "ACT_PICK_TS", "ACT_STAGE_DATE", "ACT_STAGE_TS", "SHIFT", "BADGE_STAGE", "BADGE_SHIP", "BADGE_RECEIVE", "ACT_SHIP_DATE", "ACT_SHIP_TS", "ARVL_DT", "ARVL_DATE", "ACT_RECEIVE_TS", "ACT_DELIVER_TS", "ACT_DELIVER_DT", "TRUCK_TRAIN", "Status", "Source", "CURRENT_REC", "CURRENT_TIMESTAMP") AS 
  SELECT
UWPB.SERIAL_NUMBER,
UWPB.SECTION,
UWPB.PART_BOARD,
CPT.MATL_LD_BARCODE,
CPT.LOC,
CASE WHEN UWPB.PART_BOARD LIKE '%Bulk%' 
OR UWPB.PART_BOARD LIKE '%BULK%'
OR UWPB.PART_BOARD LIKE '%SHAFT%' 
OR UWPB.PART_BOARD LIKE '%URACK%' 
OR UWPB.PART_BOARD LIKE '%Film%'
OR UWPB.PART_BOARD LIKE '%FILM%' 
OR UWPB.PART_BOARD LIKE '%ACCUMULATOR%'  
OR UWPB.PART_BOARD LIKE '%TIE ROD%' THEN 'Normal' 
ELSE 'Other' END AS BOARD_TYPES,
TO_DATE(UWPB.ACT_PICK_TS, 'DD-MM-YY') ACT_PICK_DATE,
UWPB.ACT_PICK_TS,
TO_DATE(UWPB.ACT_STAGE_TS, 'DD-MM-YY') ACT_STAGE_DATE,
UWPB.ACT_STAGE_TS,
CASE WHEN EXTRACT(HOUR FROM CAST(UWPB.ACT_STAGE_TS AS TIMESTAMP)) >= 7 AND EXTRACT(HOUR FROM CAST(UWPB.ACT_STAGE_TS AS TIMESTAMP)) <15 THEN '1st Shift'
WHEN EXTRACT(HOUR FROM CAST(UWPB.ACT_STAGE_TS AS TIMESTAMP)) >= 15 AND EXTRACT(HOUR FROM CAST(UWPB.ACT_STAGE_TS AS TIMESTAMP)) <23 THEN '2nd Shift'
ELSE '3rd Shift' END AS SHIFT,
UWPB.BADGE_STAGE,
UWPB.BADGE_SHIP,
CASE WHEN UWPB.BADGE_RECEIVE IS NULL AND  UWPB.BADGE_SHIP IS NOT NULL THEN UWPB.BADGE_SHIP 
WHEN UWPB.BADGE_RECEIVE IS NULL AND  UWPB.BADGE_SHIP IS  NULL AND UWPB.BADGE_STAGE IS NOT NULL THEN UWPB.BADGE_STAGE
ELSE  UWPB.BADGE_RECEIVE END AS BADGE_RECEIVE,
TO_DATE(UWPB.ACT_SHIP_TS, 'DD-MM-YY') ACT_SHIP_DATE,
UWPB.ACT_SHIP_TS AS ACT_SHIP_TS,
CPT.ARVL_DT,
TO_DATE(CPT.ARVL_DT, 'DD-MM-YY') ARVL_DATE,

CASE WHEN CAST(MIN(CPT.ARVL_DT) OVER(PARTITION BY  BCT_BAR_CODE, TRNSP_VEH_BARCODE) AS TIMESTAMP) IS NULL 
THEN UWPB.ACT_STAGE_TS ELSE CAST(MIN(CPT.ARVL_DT) OVER(PARTITION BY  BCT_BAR_CODE, TRNSP_VEH_BARCODE) AS TIMESTAMP) END AS ACT_RECEIVE_TS,

UWPB.ACT_DELIVER_TS,
TO_DATE(UWPB.ACT_DELIVER_TS, 'DD-MM-YY') ACT_DELIVER_DT,
TRNSP_VEH_BARCODE AS TRUCK_TRAIN,
'DELIVERED' AS Status,
'W SPRMRKT' AS Source,
CPT.CURRENT_REC,

CURRENT_TIMESTAMP

FROM  SPRMRKTMGR.UNIT_WORK_PART_BOARD UWPB

INNER JOIN CPTMGR.V_BCT_ALL_MATERIAL@CPT.MCE.NA.CAT.COM CPT 

    ON UWPB.BCT_BAR_CODE = CPT.MATL_LD_BARCODE

      WHERE UWPB.BADGE_PICK <> 'auto' AND TO_DATE(UWPB.ACT_PICK_TS, 'DD-MM-YY') > TO_DATE(CURRENT_DATE - 45)
  AND ACT_SHIP_TS IS NOT NULL AND  ACT_RECEIVE_TS IS NULL
    AND   ( (LOC LIKE 'SUBS' AND
        (  PART_NM LIKE '%Bulk%' OR PART_NM LIKE '%BULK%'     OR PART_NM LIKE '%Film%' OR PART_NM LIKE '%FILM%' ) )
        OR
        
        
 (     (   
     PART_NM  LIKE '%ACCUMULATOR%'  
     OR PART_NM  LIKE '%TIE ROD%' 
     OR PART_NM  LIKE '%SHAFT%'  
     OR PART_NM  LIKE '%URACK%'  
     
     )
     AND   ( TRNSP_VEH_BARCODE LIKE '%CV%' OR LOC  LIKE  '%Dock 9 Hot Box%' ) 
        
    )


OR
(
  NOT(   
     PART_NM  LIKE '%ACCUMULATOR%'  
     OR PART_NM  LIKE '%TIE ROD%' 
     OR PART_NM  LIKE '%SHAFT%'  
     OR PART_NM  LIKE '%URACK%'  
     
     )
    AND  
    (
             LOC NOT LIKE '%RS4%'  
         AND LOC LIKE 'D %'
         AND LOC LIKE 'B %'
         AND LOC LIKE 'C %'
         AND LOC  LIKE  '%Dock 9 Hot Box%'
         AND LOC NOT LIKE '%ROOM%'
         AND LOC NOT LIKE '%RD%'
    )
)


 )
 
 
UNION ALL





SELECT
UWPB.SERIAL_NUMBER,
UWPB.SECTION,
UWPB.PART_BOARD,
CPT.MATL_LD_BARCODE,
CPT.LOC,
CASE WHEN UWPB.PART_BOARD LIKE '%Bulk%' 
OR UWPB.PART_BOARD LIKE '%BULK%'
OR UWPB.PART_BOARD LIKE '%SHAFT%' 
OR UWPB.PART_BOARD LIKE '%URACK%' 
OR UWPB.PART_BOARD LIKE '%Film%'
OR UWPB.PART_BOARD LIKE '%FILM%' 
OR UWPB.PART_BOARD LIKE '%ACCUMULATOR%'  
OR UWPB.PART_BOARD LIKE '%TIE ROD%' THEN 'Normal' 
ELSE 'Other' END AS BOARD_TYPES,
TO_DATE(UWPB.ACT_PICK_TS, 'DD-MM-YY') ACT_PICK_DATE,
UWPB.ACT_PICK_TS,
TO_DATE(UWPB.ACT_STAGE_TS, 'DD-MM-YY') ACT_STAGE_DATE,
UWPB.ACT_STAGE_TS,
CASE WHEN EXTRACT(HOUR FROM CAST(UWPB.ACT_STAGE_TS AS TIMESTAMP)) >= 7 AND EXTRACT(HOUR FROM CAST(UWPB.ACT_STAGE_TS AS TIMESTAMP)) <15 THEN '1st Shift'
WHEN EXTRACT(HOUR FROM CAST(UWPB.ACT_STAGE_TS AS TIMESTAMP)) >= 15 AND EXTRACT(HOUR FROM CAST(UWPB.ACT_STAGE_TS AS TIMESTAMP)) <23 THEN '2nd Shift'
ELSE '3rd Shift' END AS SHIFT,
UWPB.BADGE_STAGE,
UWPB.BADGE_SHIP,
CASE WHEN UWPB.BADGE_RECEIVE IS NULL AND  UWPB.BADGE_SHIP IS NOT NULL THEN UWPB.BADGE_SHIP 
WHEN UWPB.BADGE_RECEIVE IS NULL AND  UWPB.BADGE_SHIP IS  NULL AND UWPB.BADGE_STAGE IS NOT NULL THEN UWPB.BADGE_STAGE
ELSE  UWPB.BADGE_RECEIVE END AS BADGE_RECEIVE,
TO_DATE(UWPB.ACT_SHIP_TS, 'DD-MM-YY') ACT_SHIP_DATE,
UWPB.ACT_SHIP_TS AS ACT_SHIP_TS,
CPT.ARVL_DT,
TO_DATE(CPT.ARVL_DT, 'DD-MM-YY') ARVL_DATE,
CASE WHEN CAST(MIN(CPT.ARVL_DT) OVER(PARTITION BY  BCT_BAR_CODE, TRNSP_VEH_BARCODE) AS TIMESTAMP) IS NULL 
THEN UWPB.ACT_STAGE_TS ELSE CAST(MIN(CPT.ARVL_DT) OVER(PARTITION BY  BCT_BAR_CODE, TRNSP_VEH_BARCODE) AS TIMESTAMP) END AS ACT_RECEIVE_TS,
UWPB.ACT_DELIVER_TS,
TO_DATE(UWPB.ACT_DELIVER_TS, 'DD-MM-YY') ACT_DELIVER_DT,
TRNSP_VEH_BARCODE AS TRUCK_TRAIN,
'DELIVERED' AS Status,
'CP SPRMRKT' AS Source,
CPT.CURRENT_REC,
CURRENT_TIMESTAMP
FROM  RSPRMRKTMGR.UNIT_WORK_PART_BOARD@RSPRMRKTMGR.CIS.CAT.COM UWPB
INNER JOIN CPTMGR.V_BCT_ALL_MATERIAL@CPT.MCE.NA.CAT.COM CPT 
    ON UWPB.BCT_BAR_CODE = CPT.MATL_LD_BARCODE
   
    WHERE UWPB.BADGE_PICK <> 'auto' AND TO_DATE(UWPB.ACT_PICK_TS, 'DD-MM-YY') > TO_DATE(CURRENT_DATE - 45)
  AND ACT_SHIP_TS IS NOT NULL AND  ACT_RECEIVE_TS IS NULL
    AND   ( (LOC LIKE 'SUBS' AND
        (  PART_NM LIKE '%Bulk%' OR PART_NM LIKE '%BULK%'     OR PART_NM LIKE '%Film%' OR PART_NM LIKE '%FILM%' ) )
        OR
        
        
 (     (   
     PART_NM  LIKE '%ACCUMULATOR%'  
     OR PART_NM  LIKE '%TIE ROD%' 
     OR PART_NM  LIKE '%SHAFT%'  
     OR PART_NM  LIKE '%URACK%'  
     
     )
     AND   ( TRNSP_VEH_BARCODE LIKE '%CV%' OR LOC  LIKE  '%Dock 9 Hot Box%' ) 
        
    )


OR
(
  NOT(   
     PART_NM  LIKE '%ACCUMULATOR%'  
     OR PART_NM  LIKE '%TIE ROD%' 
     OR PART_NM  LIKE '%SHAFT%'  
     OR PART_NM  LIKE '%URACK%'  
     
     )
    AND  
    (
             LOC NOT LIKE '%RS4%'  
         AND LOC LIKE 'D %'
         AND LOC LIKE 'B %'
         AND LOC LIKE 'C %'
         AND LOC  LIKE  '%Dock 9 Hot Box%'
         AND LOC NOT LIKE '%ROOM%'
         AND LOC NOT LIKE '%RD%'
    )
)


 )
 
    UNION ALL  

SELECT
UWPB.SERIAL_NUMBER,
UWPB.SECTION,
UWPB.PART_BOARD,
CPT.MATL_LD_BARCODE,
CPT.LOC,
CASE WHEN UWPB.PART_BOARD LIKE '%Bulk%' 
OR UWPB.PART_BOARD LIKE '%BULK%'
OR UWPB.PART_BOARD LIKE '%SHAFT%' 
OR UWPB.PART_BOARD LIKE '%URACK%' 
OR UWPB.PART_BOARD LIKE '%Film%'
OR UWPB.PART_BOARD LIKE '%FILM%' 
OR UWPB.PART_BOARD LIKE '%ACCUMULATOR%'  
OR UWPB.PART_BOARD LIKE '%TIE ROD%' THEN 'Normal' 
ELSE 'Other' END AS BOARD_TYPES,
TO_DATE(UWPB.ACT_PICK_TS, 'DD-MM-YY') ACT_PICK_DATE,
UWPB.ACT_PICK_TS,
TO_DATE(UWPB.ACT_STAGE_TS, 'DD-MM-YY') ACT_STAGE_DATE,
UWPB.ACT_STAGE_TS,
CASE WHEN EXTRACT(HOUR FROM CAST(UWPB.ACT_STAGE_TS AS TIMESTAMP)) >= 7 AND EXTRACT(HOUR FROM CAST(UWPB.ACT_STAGE_TS AS TIMESTAMP)) <15 THEN '1st Shift'
WHEN EXTRACT(HOUR FROM CAST(UWPB.ACT_STAGE_TS AS TIMESTAMP)) >= 15 AND EXTRACT(HOUR FROM CAST(UWPB.ACT_STAGE_TS AS TIMESTAMP)) <23 THEN '2nd Shift'
ELSE '3rd Shift' END AS SHIFT,
UWPB.BADGE_STAGE,
CASE WHEN UWPB.BADGE_SHIP IS NULL THEN UWPB.BADGE_STAGE ELSE  UWPB.BADGE_SHIP END AS BADGE_SHIP,
UWPB.BADGE_RECEIVE,
TO_DATE(UWPB.ACT_SHIP_TS, 'DD-MM-YY') ACT_SHIP_DATE,
CASE WHEN ACT_STAGE_TS IS NOT  NULL AND ACT_SHIP_TS IS NULL THEN UWPB.ACT_STAGE_TS 
WHEN UWPB.ACT_SHIP_TS IS NULL THEN CAST(MIN(CPT.ARVL_DT) OVER(PARTITION BY  BCT_BAR_CODE, TRNSP_VEH_BARCODE) AS TIMESTAMP)
            ELSE UWPB.ACT_SHIP_TS END AS ACT_SHIP_TS,
CPT.ARVL_DT,
TO_DATE(CPT.ARVL_DT, 'DD-MM-YY') ARVL_DATE,

UWPB.ACT_RECEIVE_TS AS ACT_RECEIVE_TS,
UWPB.ACT_DELIVER_TS,
TO_DATE(UWPB.ACT_DELIVER_TS, 'DD-MM-YY') ACT_DELIVER_DT,
TRNSP_VEH_BARCODE AS TRUCK_TRAIN,
'SHIPPED' AS Status,
'W SPRMRKT' AS Source,
CPT.CURRENT_REC,

CURRENT_TIMESTAMP

FROM  SPRMRKTMGR.UNIT_WORK_PART_BOARD UWPB

INNER JOIN CPTMGR.V_BCT_ALL_MATERIAL@CPT.MCE.NA.CAT.COM CPT 

    ON UWPB.BCT_BAR_CODE = CPT.MATL_LD_BARCODE

    WHERE UWPB.BADGE_PICK <> 'auto' AND TO_DATE(UWPB.ACT_PICK_TS, 'DD-MM-YY') > TO_DATE(CURRENT_DATE - 45)
    AND  ACT_STAGE_TS IS NOT NULL AND  ACT_SHIP_TS IS NULL
    AND( LOC LIKE 'SUBS' AND (   PART_NM LIKE '%Bulk%' OR PART_NM LIKE '%Film%' ))
    
    OR
    
    
    (      ACT_STAGE_TS IS  NULL AND  ACT_SHIP_TS IS NULL   
     AND (   PART_NM NOT LIKE '%Bulk%'  AND PART_NM NOT LIKE '%Film%' )
     AND   ( TRNSP_VEH_BARCODE LIKE '%CV%' OR LOC  LIKE  '%Dock 9 Hot Box%' ) 
        
    )





UNION ALL

SELECT
UWPB.SERIAL_NUMBER,
UWPB.SECTION,
UWPB.PART_BOARD,
CPT.MATL_LD_BARCODE,
CPT.LOC,
CASE WHEN UWPB.PART_BOARD LIKE '%Bulk%' 
OR UWPB.PART_BOARD LIKE '%BULK%'
OR UWPB.PART_BOARD LIKE '%SHAFT%' 
OR UWPB.PART_BOARD LIKE '%URACK%' 
OR UWPB.PART_BOARD LIKE '%Film%'
OR UWPB.PART_BOARD LIKE '%FILM%' 
OR UWPB.PART_BOARD LIKE '%ACCUMULATOR%'  
OR UWPB.PART_BOARD LIKE '%TIE ROD%' THEN 'Normal' 
ELSE 'Other' END AS BOARD_TYPES,
TO_DATE(UWPB.ACT_PICK_TS, 'DD-MM-YY') ACT_PICK_DATE,
UWPB.ACT_PICK_TS,
TO_DATE(UWPB.ACT_STAGE_TS, 'DD-MM-YY') ACT_STAGE_DATE,
UWPB.ACT_STAGE_TS,
CASE WHEN EXTRACT(HOUR FROM CAST(UWPB.ACT_STAGE_TS AS TIMESTAMP)) >= 7 AND EXTRACT(HOUR FROM CAST(UWPB.ACT_STAGE_TS AS TIMESTAMP)) <15 THEN '1st Shift'
WHEN EXTRACT(HOUR FROM CAST(UWPB.ACT_STAGE_TS AS TIMESTAMP)) >= 15 AND EXTRACT(HOUR FROM CAST(UWPB.ACT_STAGE_TS AS TIMESTAMP)) <23 THEN '2nd Shift'
ELSE '3rd Shift' END AS SHIFT,
UWPB.BADGE_STAGE,
CASE WHEN UWPB.BADGE_SHIP IS NULL THEN UWPB.BADGE_STAGE ELSE  UWPB.BADGE_SHIP END AS BADGE_SHIP,
UWPB.BADGE_RECEIVE,
TO_DATE(UWPB.ACT_SHIP_TS, 'DD-MM-YY') ACT_SHIP_DATE,
CASE WHEN CAST(MIN(CPT.ARVL_DT) OVER(PARTITION BY  BCT_BAR_CODE, TRNSP_VEH_BARCODE) AS TIMESTAMP) IS NULL 
     THEN ACT_STAGE_TS 
     ELSE CAST(MIN(CPT.ARVL_DT) OVER(PARTITION BY  BCT_BAR_CODE, TRNSP_VEH_BARCODE) AS TIMESTAMP) END AS ACT_SHIP_TS,

CPT.ARVL_DT,
TO_DATE(CPT.ARVL_DT, 'DD-MM-YY') ARVL_DATE,

UWPB.ACT_RECEIVE_TS AS ACT_RECEIVE_TS,
UWPB.ACT_DELIVER_TS,
TO_DATE(UWPB.ACT_DELIVER_TS, 'DD-MM-YY') ACT_DELIVER_DT,
TRNSP_VEH_BARCODE AS TRUCK_TRAIN,
 'SHIPPED' AS Status,
'CP SPRMRKT' AS Source,
CPT.CURRENT_REC,

CURRENT_TIMESTAMP

FROM  RSPRMRKTMGR.UNIT_WORK_PART_BOARD@RSPRMRKTMGR.CIS.CAT.COM UWPB

INNER JOIN CPTMGR.V_BCT_ALL_MATERIAL@CPT.MCE.NA.CAT.COM CPT 
    ON UWPB.BCT_BAR_CODE = CPT.MATL_LD_BARCODE
WHERE UWPB.BADGE_PICK <> 'auto' AND TO_DATE(UWPB.ACT_PICK_TS, 'DD-MM-YY') > TO_DATE(CURRENT_DATE - 45)
    AND  ACT_STAGE_TS IS NOT NULL AND  ACT_SHIP_TS IS NULL
    AND( LOC LIKE 'SUBS' AND (   PART_NM LIKE '%Bulk%' OR PART_NM LIKE '%Film%' ))
    
    OR
    
    
    (      ACT_STAGE_TS IS  NULL AND  ACT_SHIP_TS IS NULL   
     AND (   PART_NM NOT LIKE '%Bulk%'  AND PART_NM NOT LIKE '%Film%' )
     AND   ( TRNSP_VEH_BARCODE LIKE '%CV%' OR LOC  LIKE  '%Dock 9 Hot Box%' ) 
        
    )
;



*******************************************************
--------------------------------------------------------
--  DDL for View FORWARDLOOK_TABLEAU_V2
--------------------------------------------------------

  CREATE OR REPLACE FORCE EDITIONABLE VIEW "MINIMARKET"."FORWARDLOOK_TABLEAU_V2" ("MODEL", "RCVD_DT", "ETA_DATE", "ETA_QUANTITY", "COMMENTS", "POU_COMMENTS", "HISTORY_COMMENTS", "UPDATEDDT", "DEMAND_TYPE", "PRIORITY_ORDER", "FAC_CD", "DAY_NO", "SERIAL_NUMBER", "SUPPLIER_CODE", "SUPPLIER_NAME", "PART_NAME", "PRODUCT_GROUP", "SECTION", "STAGE", "REC_LOC", "LPA_NAME", "TRANSIT_DAYS", "STATUS", "REQ_DT", "WORK_WEEK", "REQ_SUP_SHIP_DT", "REQ_QTY", "TOTAL_QTY", "SCH_BLD_DT", "ACT_BLD_DT", "AVL_QTY", "MISSING_QTY", "IS_ACTIVE", "REFRESHED_DT", "SCH_SOL_DT", "ACT_SOL_DT", "PART_NUMBER", "SHOW_STOPPER", "MTS_TOTAL_QTY", "RISK_LEVEL", "SPUR", "SPUR_NAME", "ORDER_SEQUENCE", "EXE_SCH_SOL_DT", "EXE_SCH_BLD_DT", "OPS_SCH_SOL_DT", "OPS_SCH_BLD_DT", "LEAD_TIME", "PARENT_PART", "PATH_ID", "X", "Y", "COMP_ROUTE", "BLDG", "PN_COMMENT", "FROZEN_", "SN_COMMENT", "MTS_ON_HANDS_QTY", "MRP_ON_HANDS_QTY", "OOB_FLAG", "SUPP_CD", "FAC_CD_ASN", "SHIPPED_QTY", "ASN_SHIP_DATE", "COMMENT_TXT", "PO_NO", "EST_DELIVERY_DATE", "ASN_SHIP_MODE", "ESTIMATED_PORT_ARRIVAL_DATE", "UPDATE_DATE_TS", "QUALITY_IND", "CURR_LOC", "NOH") AS 
  SELECT DISTINCT FD."MODEL",FD."RCVD_DT",FD."ETA_DATE",FD."ETA_QUANTITY",FD."COMMENTS",FD."POU_COMMENTS",FD."HISTORY_COMMENTS", FD."UPDATEDDT", FD."DEMAND_TYPE",FD."PRIORITY_ORDER",FD."FAC_CD",FD."DAY_NO",FD."SERIAL_NUMBER",FD."SUPPLIER_CODE",FD."SUPPLIER_NAME",FD."PART_NAME",FD."PRODUCT_GROUP",FD."SECTION",FD."STAGE",FD."REC_LOC",FD."LPA_NAME",FD."TRANSIT_DAYS",FD."STATUS",FD."REQ_DT",FD."WORK_WEEK",FD."REQ_SUP_SHIP_DT",FD."REQ_QTY",FD."TOTAL_QTY",FD."SCH_BLD_DT",FD."ACT_BLD_DT",FD."AVL_QTY",FD."MISSING_QTY",
  --FD."CPT_COVERAGE",
  FD."IS_ACTIVE",FD."REFRESHED_DT",FD."SCH_SOL_DT",FD."ACT_SOL_DT",FD."PART_NUMBER",SL.SHOW_STOPPER ,FD.MTS_TOTAL_QTY,FD.risk_level,FD.SPUR, FD.SPUR_NAME
   , FD.ORDER_SEQUENCE
   , FD.EXE_SCH_SOL_DT
   , FD.EXE_SCH_BLD_DT
   , FD.OPS_SCH_SOL_DT
   , FD.OPS_SCH_BLD_DT
   , FD.LEAD_TIME
   , FD.PARENT_PART
   ,P.PATH_ID
   ,P.X
   ,P.Y
   ,P.COMP_ROUTE
   ,P.BLDG
   ,PCT.PN_COMMENT
   --,PCT.G2G
   ,SNCT.FROZEN_
   ,SNCT.SN_COMMENT
   ,MTS.ind_ld_qty AS  MTS_ON_HANDS_QTY
   ,MRP.qty AS MRP_ON_HANDS_QTY
   ,CASE WHEN MTS.ind_ld_qty != MRP.qty THEN 'YES' ELSE 'NO' END AS OOB_FLAG
   ,ASN.SUPP_CD
   ,ASN.FAC_CD AS FAC_CD_ASN
   ,ASN.SHIPPED_QTY
   ,ASN.ASN_SHIP_DATE
   ,ASN.COMMENT_TXT
   ,ASN.PO_NO
   ,ASN.EST_DELIVERY_DATE
   ,ASN.ASN_SHIP_MODE
   ,ASN.ESTIMATED_PORT_ARRIVAL_DATE
   ,ASN.UPDATE_DATE_TS
   ,ASN.QUALITY_IND
   --,RTYT.Curr_Loc
   ,CASE WHEN RTYT.curr_loc = 'W KIT' THEN 'W KIT'
     WHEN RTYT.curr_loc = 'FR KIT' THEN 'FR KIT' 
     WHEN FLR_PARTS.CNSM_ITM_CAT_ID_NO IS NOT NULL THEN 'FLR' 
     ELSE NULL END AS Curr_Loc
   ,NOH.NOH
  FROM 
  
  
  (SELECT   
DDET.model,
cpt.RCVD_DT,
cpt.ETA_DATE,
cpt.ETA_QUANTITY,
cpt.COMMENTS,
cpt.POU_COMMENTS,
cpt.HISTORY_COMMENTS,
cpt.UPDATEDDT,
DM.demand_type,
    DM.priority_order,
    DM.fac_cd,
    DM.day_no,
    TRIM(DM.serial_number) AS SERIAL_NUMBER,
    DM.supplier_code,
    DM.supplier_name,
    DM.part_name,
    DM.product_group,
    DM.section,
    DM.stage,
    DM.rec_loc,
    DM.lpa_name,
    DM.transit_days,
    DM.status,
    DM.req_dt,
    DM.work_week,
    DM.req_sup_ship_dt,
    DM.req_qty,
    DM.total_qty,
    DM.sch_bld_dt,
    DM.act_bld_dt,
    DM.avl_qty,
    DM.missing_qty,
    --DM.cpt_coverage,
    DM.is_active,
    DM.refreshed_dt,
    DM.INDEX_NUMBER AS ORDER_SEQUENCE,
    DDET.SCH_SOL_DT, 
    DDET.ACT_SOL_DT, 
    DM.PART_NUMBER,
    --TRIM(lpad(DM.PART_NUMBER, 7, '0')) AS TRIM_PART,
    DCD.total_qty AS MTS_TOTAL_QTY, 
    HPS.risk_level,
    C2.SPUR,
    QA.MES_AREA_DESC AS SPUR_NAME,
    DM.EXE_SCH_SOL_DT,
    DM.EXE_SCH_BLD_DT,
    DM.OPS_SCH_SOL_DT,
    DM.OPS_SCH_BLD_DT,
    DM.LEAD_TIME,
    DM.PARENT_PART
    --,NDM2.ON_HAND_QTY AS ON_HAND_QTY
    --,NDM.INDEX_NUMBER AS INDEX_NUMBER
    
    from DMART_2WEEK DM
left join DMARTAPPDB.DM_DAILY_EXEC_TRACKER_DATA@z1pdd.cis.cat.com DDET
ON DM.SERIAL_NUMBER = DDET.SERIAL_NUMBER
left join CPTCOMPLIANCE cpt 
on dm.PART_NUMBER = cpt.PART_NUMBER 
LEFT JOIN HIGH_PAIN_SUPPLIERS HPS
ON DM.supplier_code = HPS.supplier_code
LEFT JOIN V_DM_COMPLETE_DEMAND_MTS_OH DCD
on dm.part_number = dcd.part_number

--LEFT JOIN 
--(
--SELECT  DISTINCT
--INDEX_NUMBER, SERIAL_NUMBER
--FROM dm_complete_demand@Z1QDD.CIS.CAT.COM
--WHERE INDEX_NUMBER IS NOT NULL
----AND INDEX_NUMBER = 38
-----ORDER BY INDEX_NUMBER
----AND SCH_BLD_DT>= '10-SEP-2021'
----GROUP BY INDEX_NUMBER, PART_NUMBER, SERIAL_NUMBER 
--) NDM
--ON dm.serial_number = NDM.SERIAL_NUMBER

--AND dm.PART_NUMBER = NDM.PART_NUMBER

--LEFT JOIN 
--(
--SELECT  
--PART_NUMBER, SUM(ON_HAND_QTY) AS ON_HAND_QTY
--FROM dm_complete_demand@Z1QDD.CIS.CAT.COM
----WHERE INDEX_NUMBER IS NOT NULL
----AND INDEX_NUMBER = 38
-----ORDER BY INDEX_NUMBER
----AND SCH_BLD_DT>= '10-SEP-2021'
--GROUP BY PART_NUMBER 
--) NDM2
--ON dm.PART_NUMBER = NDM2.PART_NUMBER

LEFT JOIN V_DMART_PN_SECTION_SPUR C2
ON TRIM(DM.PART_NUMBER)=TRIM(C2.PART_NUMBER)
AND TRIM(DM.SECTION)=TRIM(C2.SECTION)
--AND TRIM(SUBSTR(DM.SERIAL_NUMBER,1,3))=TRIM(C2.SN_PREFIX)
AND TRIM(DM.SERIAL_NUMBER) = TRIM(C2.SERIAL_NUMBER)
AND TRIM(DM.stage) = TRIM(C2.STAGE)

LEFT JOIN MES_PROD13.QWB2_AREA QA
ON TRIM(C2.SPUR)=TRIM(QA.AREA_ID)

) FD
LEFT JOIN (SELECT DISTINCT PART_NUMBER, SHOW_STOPPER FROM "MINIMARKET"."SHOW_T_TEST" ) SL
ON TRIM(FD.PART_NUMBER) = TRIM(SL.PART_NUMBER)

LEFT JOIN (SELECT   PATH_ID   ,X   , Y,  SPUR, COMP_ROUTE, BLDG FROM POLYGON_FORWARDLOOK_TABLEAU ) P
ON TRIM(FD.SPUR) = TRIM(P.SPUR)

LEFT JOIN (SELECT   part_number, pn_comment FROM part_number_comments ) PCT
ON TRIM(FD.PART_NUMBER) = TRIM(PCT.part_number)
--AND TRIM(FD.serial_number) = TRIM(PCT.serial_number)

LEFT JOIN (SELECT   serial_number, sn_comment, frozen_ FROM serial_number_ctb_tool ) SNCT
ON TRIM(FD.serial_number) = TRIM(SNCT.serial_number)

LEFT JOIN 
(
    SELECT CTCO_IDENT_NO, SUM(ind_ld_qty)  AS ind_ld_qty
    FROM sprmrktmgr.v_mts_inv
    GROUP BY CTCO_IDENT_NO
) MTS
ON TRIM(FD.PART_NUMBER) = TRIM(MTS.CTCO_IDENT_NO)

LEFT JOIN sprmrktmgr.v_mrp_oh MRP
ON TRIM(FD.PART_NUMBER) = TRIM(MRP.IDENT)

LEFT JOIN ASC_PRODTN.CV_INT_TRANSIT_DTLS@Z1PAR.CIS.CAT.COM ASN
ON TRIM(FD.PART_NUMBER) = TRIM(ASN.CAT_ID_NO)

LEFT JOIN 
(
SELECT
PART_NUMBER,
Serial_number,
CASE WHEN curr_loc = 'W KIT' THEN 'W KIT'
     WHEN curr_loc = 'FR KIT' THEN 'FR KIT' 
     ELSE NULL END AS Curr_Loc
FROM
(
SELECT 
     Serial_number 
    ,TRIM(PART_NUMBER) AS PART_NUMBER

      , CASE WHEN CURR_INV_BLDG = 'W KIT' THEN 'W KIT' 
        WHEN  CURR_INV_BLDG = 'FR KIT' THEN 'FR KIT' 
        WHEN  CURR_INV_AREA LIKE  '%W KIT%' THEN 'W KIT' 
        WHEN  CURR_INV_AREA LIKE  '%FR KIT%' THEN 'FR KIT'
        WHEN  CURR_INV_AREA LIKE  '%W REPL%' THEN 'W KIT' 
        WHEN  CURR_INV_AREA LIKE  '%W WS%' THEN 'W KIT'
        WHEN  CURR_INV_AREA LIKE  '%REPL%' THEN 'W KIT'
        ELSE CONCAT(CONCAT(CURR_INV_BLDG , ' '), CURR_INV_AREA) END as curr_loc

FROM sprmrktmgr.unit_work_missing_part
     WHERE MISSING_QTY > 0
     AND SUBSTR(TRIM(PRIMARY_LOC), 1,1) = 'D'
     
UNION  
    
SELECT
     Serial_number 
    ,TRIM(PART_NUMBER) AS PART_NUMBER
    ,CASE WHEN CURR_INV_BLDG = 'W KIT' THEN 'W KIT' 
        WHEN  CURR_INV_BLDG = 'FR KIT' THEN 'FR KIT' 
        WHEN  CURR_INV_AREA LIKE  '%W KIT%' THEN 'W KIT' 
        WHEN  CURR_INV_AREA LIKE  '%FR KIT%' THEN 'FR KIT' 
        WHEN  CURR_INV_AREA LIKE  '%W REPL%' THEN 'W KIT' 
        WHEN  CURR_INV_AREA LIKE  '%W WS%' THEN 'W KIT'
        WHEN  CURR_INV_AREA LIKE  '%REPL%' THEN 'W KIT'
        ELSE CONCAT(CONCAT(CURR_INV_BLDG , ' '), CURR_INV_AREA) END as curr_loc2 
FROM rsprmrktmgr.unit_work_missing_part@RSPRMRKTMGR.CIS.CAT.COM
WHERE MISSING_QTY > 0
AND SUBSTR(TRIM(PRIMARY_LOC), 1,1) = 'D'

)
)RTYT
ON TRIM(FD.PART_NUMBER) = TRIM(RTYT.PART_NUMBER)
AND TRIM(FD.serial_number) = TRIM(RTYT.Serial_number)

LEFT JOIN DM_MSO@z1qdd.cis.cat.com NOH
ON TRIM(FD.PART_NUMBER) = TRIM(NOH.PART_NUMBER)
AND TRIM(FD.serial_number) = TRIM(NOH.SERIAL_NUMBER)

LEFT JOIN DEC_MFG_DATA.MV_MES_CNSM_ITM@A3P4.CIS.CAT.COM FLR_PARTS
ON TRIM(FD.PART_NUMBER) = TRIM(FLR_PARTS.CNSM_ITM_CAT_ID_NO)
;



*******************************************************
*******************************************************
